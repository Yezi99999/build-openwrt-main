# OpenWrt æ™ºèƒ½ç¼–è¯‘å·¥ä½œæµ - å®‰å…¨ç‰ˆæœ¬
# æ”¯æŒé€šè¿‡Webç•Œé¢è§¦å‘çš„è‡ªåŠ¨åŒ–ç¼–è¯‘

name: ğŸ› ï¸ OpenWrt æ™ºèƒ½ç¼–è¯‘

on:
  # æ”¯æŒé€šè¿‡Repository Dispatchè§¦å‘ï¼ˆæ¥è‡ªWebç•Œé¢ï¼‰
  repository_dispatch:
    types: [web_build]
  
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      source_branch:
        description: "æºç åˆ†æ”¯"
        required: true
        default: "openwrt-main"
        type: choice
        options:
          - openwrt-main
          - lede-master
          - immortalwrt-master
      
      target_device:
        description: "ç›®æ ‡è®¾å¤‡"
        required: true
        default: "x86_64"
        type: choice
        options:
          - x86_64
          - xiaomi_4a_gigabit
          - newifi_d2
          - rpi_4b
          - nanopi_r2s
      
      plugins_list:
        description: "æ’ä»¶åˆ—è¡¨(ç”¨é€—å·åˆ†éš”)"
        required: false
        default: ""
        type: string
      
      build_description:
        description: "ç¼–è¯‘æè¿°"
        required: false
        default: "æ™ºèƒ½ç¼–è¯‘"
        type: string

# ç¯å¢ƒå˜é‡é…ç½®
env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  FEEDS_CONF: feeds.conf.default
  CONFIG_FILE: .config
  DIY_P1_SH: diy-part1.sh
  DIY_P2_SH: diy-part2.sh
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  # å‡†å¤‡é˜¶æ®µï¼šè§£æé…ç½®å’Œè®¾ç½®ç¯å¢ƒ
  prepare:
    runs-on: ubuntu-20.04
    name: ğŸ“‹ é…ç½®è§£æ
    outputs:
      source_branch: ${{ steps.config.outputs.source_branch }}
      target_device: ${{ steps.config.outputs.target_device }}
      plugins_list: ${{ steps.config.outputs.plugins_list }}
      build_tag: ${{ steps.config.outputs.build_tag }}
      repo_url: ${{ steps.config.outputs.repo_url }}
      repo_branch: ${{ steps.config.outputs.repo_branch }}
      device_profile: ${{ steps.config.outputs.device_profile }}
      
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
      
      - name: âš™ï¸ è§£æç¼–è¯‘é…ç½®
        id: config
        run: |
          # ä¼˜å…ˆä½¿ç”¨Repository Dispatchçš„é…ç½®ï¼Œå…¶æ¬¡ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "ğŸŒ æ£€æµ‹åˆ°Webç•Œé¢è§¦å‘çš„ç¼–è¯‘è¯·æ±‚"
            SOURCE_BRANCH="${{ github.event.client_payload.source_branch }}"
            TARGET_DEVICE="${{ github.event.client_payload.target_device }}"
            PLUGINS_LIST="${{ github.event.client_payload.plugins }}"
            BUILD_DESC="Webç•Œé¢ç¼–è¯‘"
          else
            echo "ğŸ–±ï¸ æ£€æµ‹åˆ°æ‰‹åŠ¨è§¦å‘çš„ç¼–è¯‘è¯·æ±‚"
            SOURCE_BRANCH="${{ github.event.inputs.source_branch }}"
            TARGET_DEVICE="${{ github.event.inputs.target_device }}"
            PLUGINS_LIST="${{ github.event.inputs.plugins_list }}"
            BUILD_DESC="${{ github.event.inputs.build_description }}"
          fi
          
          # è®¾ç½®é»˜è®¤å€¼
          SOURCE_BRANCH=${SOURCE_BRANCH:-"lede-master"}
          TARGET_DEVICE=${TARGET_DEVICE:-"x86_64"}
          PLUGINS_LIST=${PLUGINS_LIST:-""}
          BUILD_DESC=${BUILD_DESC:-"æ™ºèƒ½ç¼–è¯‘"}
          
          echo "ğŸ“‹ ç¼–è¯‘é…ç½®ä¿¡æ¯:"
          echo "  æºç åˆ†æ”¯: $SOURCE_BRANCH"
          echo "  ç›®æ ‡è®¾å¤‡: $TARGET_DEVICE"
          echo "  æ’ä»¶åˆ—è¡¨: $PLUGINS_LIST"
          echo "  ç¼–è¯‘æè¿°: $BUILD_DESC"
          
          # æ ¹æ®æºç åˆ†æ”¯è®¾ç½®ä»“åº“ä¿¡æ¯
          case $SOURCE_BRANCH in
            "openwrt-main")
              REPO_URL="https://github.com/openwrt/openwrt"
              REPO_BRANCH="openwrt-23.05"
              SOURCE_NAME="OpenWrtå®˜æ–¹"
              ;;
            "lede-master")
              REPO_URL="https://github.com/coolsnowwolf/lede"
              REPO_BRANCH="master"
              SOURCE_NAME="Lean's LEDE"
              ;;
            "immortalwrt-master")
              REPO_URL="https://github.com/immortalwrt/immortalwrt"
              REPO_BRANCH="openwrt-23.05"
              SOURCE_NAME="ImmortalWrt"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„æºç åˆ†æ”¯: $SOURCE_BRANCH"
              exit 1
              ;;
          esac
          
          # æ ¹æ®ç›®æ ‡è®¾å¤‡è®¾ç½®é…ç½®æ–‡ä»¶
          case $TARGET_DEVICE in
            "x86_64")
              DEVICE_PROFILE="x86-64"
              DEVICE_NAME="X86_64"
              TARGET_SYSTEM="x86/64"
              ;;
            "xiaomi_4a_gigabit")
              DEVICE_PROFILE="xiaomi_mi-router-4a-gigabit"
              DEVICE_NAME="å°ç±³4Aåƒå…†ç‰ˆ"
              TARGET_SYSTEM="ramips/mt7621"
              ;;
            "newifi_d2")
              DEVICE_PROFILE="newifi-d2"
              DEVICE_NAME="æ–°è·¯ç”±3"
              TARGET_SYSTEM="ramips/mt7621"
              ;;
            "rpi_4b")
              DEVICE_PROFILE="rpi-4"
              DEVICE_NAME="æ ‘è“æ´¾4B"
              TARGET_SYSTEM="bcm27xx/bcm2711"
              ;;
            "nanopi_r2s")
              DEVICE_PROFILE="friendlyarm_nanopi-r2s"
              DEVICE_NAME="NanoPi_R2S"
              TARGET_SYSTEM="rockchip/armv8"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„ç›®æ ‡è®¾å¤‡: $TARGET_DEVICE"
              exit 1
              ;;
          esac
          
          # ç”Ÿæˆæ„å»ºæ ‡ç­¾
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BUILD_TAG="OpenWrt_${SOURCE_NAME// /}_${DEVICE_NAME// /_}_${TIMESTAMP}"
          
          # è¾“å‡ºå˜é‡
          echo "source_branch=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
          echo "target_device=$TARGET_DEVICE" >> $GITHUB_OUTPUT
          echo "plugins_list=$PLUGINS_LIST" >> $GITHUB_OUTPUT
          echo "build_tag=$BUILD_TAG" >> $GITHUB_OUTPUT
          echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT
          echo "repo_branch=$REPO_BRANCH" >> $GITHUB_OUTPUT
          echo "device_profile=$DEVICE_PROFILE" >> $GITHUB_OUTPUT
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "REPO_URL=$REPO_URL" >> $GITHUB_ENV
          echo "REPO_BRANCH=$REPO_BRANCH" >> $GITHUB_ENV
          echo "SOURCE_NAME=$SOURCE_NAME" >> $GITHUB_ENV
          echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
          echo "DEVICE_PROFILE=$DEVICE_PROFILE" >> $GITHUB_ENV
          echo "TARGET_SYSTEM=$TARGET_SYSTEM" >> $GITHUB_ENV
          echo "BUILD_TAG=$BUILD_TAG" >> $GITHUB_ENV
          echo "PLUGINS_LIST=$PLUGINS_LIST" >> $GITHUB_ENV
          
          echo "âœ… é…ç½®è§£æå®Œæˆ"

  # ç¼–è¯‘é˜¶æ®µï¼šå®é™…çš„å›ºä»¶ç¼–è¯‘è¿‡ç¨‹
  build:
    runs-on: ubuntu-20.04
    needs: prepare
    name: ğŸ”¨ å›ºä»¶ç¼–è¯‘
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: ğŸš€ åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "ğŸ”§ å¼€å§‹åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ..."
          
          # æ¸…ç†Dockeré•œåƒé‡Šæ”¾ç©ºé—´
          docker rmi $(docker images -q) 2>/dev/null || true
          
          # æ¸…ç†ä¸å¿…è¦çš„è½¯ä»¶åŒ…
          sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d /usr/local/lib/android 2>/dev/null || true
          sudo -E apt-get -qq update
          sudo -E apt-get -qq purge azure-cli ghc* zulu* llvm* firefox google* dotnet* powershell openjdk* mongodb* moby* || true
          
          # å®‰è£…ç¼–è¯‘ä¾èµ–
          sudo -E apt-get -qq install $(curl -fsSL https://is.gd/depend_ubuntu2204_openwrt)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          
          # åˆ›å»ºå·¥ä½œç›®å½•
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir
          
          echo "âœ… ç¼–è¯‘ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      - name: ğŸ“¦ å…‹éš†æºç 
        working-directory: /workdir
        run: |
          echo "ğŸ“¦ å¼€å§‹å…‹éš†æºç ..."
          echo "  ä»“åº“: ${{ needs.prepare.outputs.repo_url }}"
          echo "  åˆ†æ”¯: ${{ needs.prepare.outputs.repo_branch }}"
          
          df -hT $PWD
          git clone ${{ needs.prepare.outputs.repo_url }} -b ${{ needs.prepare.outputs.repo_branch }} openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
          
          echo "âœ… æºç å…‹éš†å®Œæˆ"

      - name: ğŸ”§ åŠ è½½è‡ªå®šä¹‰feeds
        run: |
          echo "ğŸ”§ é…ç½®è‡ªå®šä¹‰feeds..."
          
          # å¦‚æœå­˜åœ¨è‡ªå®šä¹‰feedsé…ç½®æ–‡ä»¶åˆ™ä½¿ç”¨ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤é…ç½®
          if [ -f "feeds.conf.default" ]; then
            cp feeds.conf.default openwrt/feeds.conf.default
            echo "ğŸ“‹ ä½¿ç”¨è‡ªå®šä¹‰feedsé…ç½®"
          fi
          
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          echo "âœ… feedsé…ç½®å®Œæˆ"

      - name: âš™ï¸ ç”Ÿæˆç¼–è¯‘é…ç½®
        run: |
          echo "âš™ï¸ å¼€å§‹ç”Ÿæˆç¼–è¯‘é…ç½®..."
          cd openwrt
          
          # ç”ŸæˆåŸºç¡€é…ç½®
          make defconfig
          
          # æ ¹æ®ç›®æ ‡è®¾å¤‡è®¾ç½®é…ç½®
          echo "CONFIG_TARGET_${{ needs.prepare.outputs.device_profile }}=y" >> .config
          
          # è®¾ç½®åŸºç¡€ç³»ç»Ÿé…ç½®
          cat >> .config << EOF
          CONFIG_DEVEL=y
          CONFIG_TOOLCHAINOPTS=y
          CONFIG_BUSYBOX_CUSTOM=y
          CONFIG_BUSYBOX_CONFIG_FEATURE_USERNAME_COMPLETION=y
          CONFIG_BUSYBOX_CONFIG_FEATURE_EDITING_SAVEHISTORY=y
          CONFIG_BUSYBOX_CONFIG_FEATURE_EDITING_VI=y
          CONFIG_COLLECT_KERNEL_DEBUG=y
          CONFIG_IB=y
          CONFIG_IMAGEOPT=y
          CONFIG_KERNEL_BUILD_USER="OpenWrt-Builder"
          CONFIG_KERNEL_BUILD_DOMAIN="GitHub-Actions"
          CONFIG_CCACHE=y
          EOF
          
          # å¤„ç†æ’ä»¶é…ç½®
          PLUGINS="${{ needs.prepare.outputs.plugins_list }}"
          if [ -n "$PLUGINS" ]; then
            echo "ğŸ”§ é…ç½®é€‰ä¸­çš„æ’ä»¶..."
            IFS=',' read -ra PLUGIN_ARRAY <<< "$PLUGINS"
            for plugin in "${PLUGIN_ARRAY[@]}"; do
              plugin=$(echo "$plugin" | xargs) # å»é™¤ç©ºæ ¼
              if [ -n "$plugin" ]; then
                echo "CONFIG_PACKAGE_$plugin=y" >> .config
                echo "  âœ“ æ·»åŠ æ’ä»¶: $plugin"
              fi
            done
          fi
          
          # ç”Ÿæˆæœ€ç»ˆé…ç½®
          make defconfig
          
          echo "ğŸ“‹ æœ€ç»ˆé…ç½®æ–‡ä»¶ï¼š"
          cat .config | grep -E "^CONFIG_TARGET|^CONFIG_PACKAGE.*=y" | head -20
          
          echo "âœ… ç¼–è¯‘é…ç½®ç”Ÿæˆå®Œæˆ"

      - name: ğŸ“¥ ä¸‹è½½ä¾èµ–åŒ…
        id: package
        run: |
          echo "ğŸ“¥ å¼€å§‹ä¸‹è½½ä¾èµ–åŒ…..."
          cd openwrt
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
          echo "âœ… ä¾èµ–åŒ…ä¸‹è½½å®Œæˆ"

      - name: ğŸ”¨ ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
          cd openwrt
          
          echo "ä½¿ç”¨ $(nproc) çº¿ç¨‹ç¼–è¯‘"
          make -j$(nproc) V=s || make -j1 || make -j1 V=s
          
          echo "compile_status=success" >> $GITHUB_OUTPUT
          echo "âœ… å›ºä»¶ç¼–è¯‘å®Œæˆ"

      - name: ğŸ“Š æ£€æŸ¥ç©ºé—´ä½¿ç”¨
        if: (!cancelled())
        run: df -hT

      - name: ğŸ“¦ æ•´ç†ç¼–è¯‘äº§ç‰©
        id: organize
        if: steps.compile.outputs.compile_status == 'success'
        run: |
          cd openwrt/bin/targets/*/*
          rm -rf packages
          
          # è®¡ç®—å›ºä»¶å¤§å°
          FIRMWARE_SIZE=$(du -sh . | cut -f1)
          echo "FIRMWARE_SIZE=$FIRMWARE_SIZE" >> $GITHUB_ENV
          
          # é‡å‘½åå›ºä»¶æ–‡ä»¶
          for file in *; do
            if [[ "$file" == *.bin ]] || [[ "$file" == *.img ]] || [[ "$file" == *.gz ]]; then
              # æå–æ–‡ä»¶æ‰©å±•å
              EXT="${file##*.}"
              # ç”Ÿæˆæ–°æ–‡ä»¶å
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              SOURCE_NAME_CLEAN=$(echo "${SOURCE_NAME:-${{ env.SOURCE_NAME }}}" | tr -d ' ')
              DEVICE_NAME_CLEAN=$(echo "${DEVICE_NAME:-${{ env.DEVICE_NAME }}}" | tr ' ' '_')
              NEW_NAME="OpenWrt_${SOURCE_NAME_CLEAN}_${DEVICE_NAME_CLEAN}_${TIMESTAMP}.${EXT}"
              mv "$file" "$NEW_NAME"
              echo "ğŸ“¦ é‡å‘½å: $file -> $NEW_NAME"
            fi
          done
          
          # ç”Ÿæˆè¯¦ç»†çš„å›ºä»¶ä¿¡æ¯æ–‡ä»¶
          cat > firmware_info.txt << EOF
          OpenWrt æ™ºèƒ½ç¼–è¯‘å›ºä»¶ä¿¡æ¯
          ========================
          
          ğŸ“‹ åŸºæœ¬ä¿¡æ¯:
          ç¼–è¯‘æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
          æ„å»ºæ ‡ç­¾: ${{ needs.prepare.outputs.build_tag }}
          æºç åˆ†æ”¯: ${{ env.SOURCE_NAME }}
          ç›®æ ‡è®¾å¤‡: ${{ env.DEVICE_NAME }}
          å›ºä»¶å¤§å°: ${FIRMWARE_SIZE}
          
          ğŸ”§ ç¼–è¯‘é…ç½®:
          é€‰ä¸­æ’ä»¶: ${{ needs.prepare.outputs.plugins_list }}
          è®¾å¤‡é…ç½®: ${{ needs.prepare.outputs.device_profile }}
          
          ğŸ“± é»˜è®¤ä¿¡æ¯:
          - é»˜è®¤IPåœ°å€: 192.168.1.1
          - é»˜è®¤ç”¨æˆ·å: root
          - é»˜è®¤å¯†ç : password
          - é»˜è®¤WiFiå: OpenWrt (å¦‚æ”¯æŒ)
          - é»˜è®¤WiFiå¯†ç : æ— 
          
          ğŸ“– ä½¿ç”¨è¯´æ˜:
          1. åˆ·æœºå‰è¯·ç¡®è®¤è®¾å¤‡å‹å·å’Œç¡¬ä»¶ç‰ˆæœ¬
          2. å»ºè®®å…ˆå¤‡ä»½åŸå‚å›ºä»¶
          3. åˆ·æœºæœ‰é£é™©ï¼Œè¯·è°¨æ…æ“ä½œ
          4. å¦‚é‡é—®é¢˜å¯å°è¯•æ•‘ç –æ“ä½œ
          
          ğŸ”— ç›¸å…³é“¾æ¥:
          - é¡¹ç›®åœ°å€: https://github.com/${{ github.repository }}
          - OpenWrtå®˜ç½‘: https://openwrt.org
          - ä½¿ç”¨æ–‡æ¡£: https://github.com/${{ github.repository }}/wiki
          
          âš ï¸ å…è´£å£°æ˜:
          æœ¬å›ºä»¶ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä½¿ç”¨è€…éœ€è‡ªè¡Œæ‰¿æ‹…åˆ·æœºé£é™©ã€‚
          EOF
          
          # ç”ŸæˆSHA256æ ¡éªŒæ–‡ä»¶
          for file in OpenWrt_*.bin OpenWrt_*.img OpenWrt_*.gz; do
            if [ -f "$file" ]; then
              sha256sum "$file" >> sha256sums.txt
              echo "ğŸ”’ ç”Ÿæˆæ ¡éªŒ: $file"
            fi
          done
          
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
          echo "organize_status=success" >> $GITHUB_OUTPUT
          echo "âœ… ç¼–è¯‘äº§ç‰©æ•´ç†å®Œæˆ"

      - name: â¬†ï¸ ä¸Šä¼ å›ºä»¶åˆ° Artifacts
        uses: actions/upload-artifact@v3
        if: steps.organize.outputs.organize_status == 'success'
        with:
          name: ${{ needs.prepare.outputs.build_tag }}
          path: ${{ env.FIRMWARE_PATH }}
          retention-days: 7

      - name: ğŸ‰ ç”Ÿæˆå‘å¸ƒç‰ˆæœ¬
        id: release
        if: env.UPLOAD_RELEASE == 'true' && steps.organize.outputs.organize_status == 'success'
        run: |
          RELEASE_TAG="${{ needs.prepare.outputs.build_tag }}"
          RELEASE_NAME="OpenWrt æ™ºèƒ½ç¼–è¯‘ - ${{ env.DEVICE_NAME }} ($(date '+%Y-%m-%d %H:%M'))"
          
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ å‘å¸ƒä¿¡æ¯:"
          echo "æ ‡ç­¾: $RELEASE_TAG"
          echo "åç§°: $RELEASE_NAME"

      - name: ğŸ“¢ å‘å¸ƒå›ºä»¶åˆ° Releases
        uses: softprops/action-gh-release@v1
        if: steps.release.outputs.release_tag != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.release.outputs.release_tag }}
          name: ${{ steps.release.outputs.release_name }}
          body_path: ${{ env.FIRMWARE_PATH }}/firmware_info.txt
          files: |
            ${{ env.FIRMWARE_PATH }}/OpenWrt_*
            ${{ env.FIRMWARE_PATH }}/sha256sums.txt
          draft: false
          prerelease: false

      - name: ğŸ“Š ç¼–è¯‘å®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ‰ OpenWrtæ™ºèƒ½ç¼–è¯‘ä»»åŠ¡å®Œæˆ!"
          echo "ğŸ“¦ å›ºä»¶ä¿¡æ¯:"
          echo "  æºç : ${{ env.SOURCE_NAME }}"
          echo "  è®¾å¤‡: ${{ env.DEVICE_NAME }}"
          echo "  å¤§å°: ${{ env.FIRMWARE_SIZE }}"
          echo "  æ ‡ç­¾: ${{ needs.prepare.outputs.build_tag }}"
          echo ""
          echo "ğŸ”— ä¸‹è½½é“¾æ¥:"
          echo "  Artifacts: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "  Releases: https://github.com/${{ github.repository }}/releases/tag/${{ steps.release.outputs.release_tag }}"
          echo ""
          echo "ğŸ“ ç¼–è¯‘æ—¥å¿—: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: ğŸ§¹ æ¸…ç†æ—§çš„å·¥ä½œæµç¨‹è®°å½•
        uses: GitRML/delete-workflow-runs@main
        with:
          retain_days: 7
          keep_minimum_runs: 5
          token: ${{ secrets.GITHUB_TOKEN }}

# ç¼–è¯‘å¤±è´¥å¤„ç†
  failure_handler:
    runs-on: ubuntu-20.04
    needs: [prepare, build]
    if: failure()
    name: âŒ ç¼–è¯‘å¤±è´¥å¤„ç†
    
    steps:
      - name: ğŸ“ ç”Ÿæˆå¤±è´¥æŠ¥å‘Š
        run: |
          echo "âŒ OpenWrtç¼–è¯‘å¤±è´¥"
          echo "ğŸ“‹ å¤±è´¥ä¿¡æ¯:"
          echo "  æºç : ${{ needs.prepare.outputs.source_branch }}"
          echo "  è®¾å¤‡: ${{ needs.prepare.outputs.target_device }}"
          echo "  æ’ä»¶: ${{ needs.prepare.outputs.plugins_list }}"
          echo "  æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "ğŸ” å¯èƒ½çš„å¤±è´¥åŸå› :"
          echo "  1. æ’ä»¶é…ç½®å†²çª"
          echo "  2. è®¾å¤‡å­˜å‚¨ç©ºé—´ä¸è¶³"
          echo "  3. ç½‘ç»œè¿æ¥é—®é¢˜"
          echo "  4. æºç æˆ–ä¾èµ–åŒ…é—®é¢˜"
          echo ""
          echo "ğŸ“– è§£å†³å»ºè®®:"
          echo "  1. æ£€æŸ¥æ’ä»¶å†²çªæ£€æµ‹ç»“æœ"
          echo "  2. å‡å°‘é€‰æ‹©çš„æ’ä»¶æ•°é‡"
          echo "  3. é€‰æ‹©æ›´ç¨³å®šçš„æºç åˆ†æ”¯"
          echo "  4. æŸ¥çœ‹è¯¦ç»†çš„ç¼–è¯‘æ—¥å¿—"
          echo ""
          echo "ğŸ”— ç¼–è¯‘æ—¥å¿—: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

# ç¼–è¯‘æˆåŠŸå¤„ç†
  success_handler:
    runs-on: ubuntu-20.04
    needs: [prepare, build]
    if: success()
    name: âœ… ç¼–è¯‘æˆåŠŸå¤„ç†
    
    steps:
      - name: ğŸ‰ ç”ŸæˆæˆåŠŸæŠ¥å‘Š
        run: |
          echo "ğŸ‰ OpenWrtç¼–è¯‘æˆåŠŸå®Œæˆ!"
          echo "ğŸ“¦ å›ºä»¶ä¿¡æ¯:"
          echo "  æºç : ${{ needs.prepare.outputs.source_branch }}"
          echo "  è®¾å¤‡: ${{ needs.prepare.outputs.target_device }}"
          echo "  æ’ä»¶: ${{ needs.prepare.outputs.plugins_list }}"
          echo "  æ ‡ç­¾: ${{ needs.prepare.outputs.build_tag }}"
          echo "  æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          echo "ğŸ“¥ ä¸‹è½½æ–¹å¼:"
          echo "  1. GitHub Actions Artifacts (7å¤©æœ‰æ•ˆæœŸ)"
          echo "  2. GitHub Releases (é•¿æœŸä¿å­˜)"
          echo ""
          echo "ğŸ”— ç›¸å…³é“¾æ¥:"
          echo "  - Actions: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "  - Releases: https://github.com/${{ github.repository }}/releases"
          echo "  - é¡¹ç›®ä¸»é¡µ: https://github.com/${{ github.repository }}"