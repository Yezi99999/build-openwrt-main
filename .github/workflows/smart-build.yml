#========================================================================================================================
# ğŸ› ï¸ OpenWrt æ™ºèƒ½ç¼–è¯‘å·¥ä½œæµ - ä¼˜åŒ–ç‰ˆæœ¬
# åŠŸèƒ½: æ¥æ”¶Webç•Œé¢ä¼ é€’çš„é…ç½®å‚æ•°ï¼Œæ™ºèƒ½ç¼–è¯‘æŒ‡å®šè®¾å¤‡å’Œæ’ä»¶çš„å›ºä»¶
# ç‰¹æ€§: æ•´åˆè„šæœ¬åŠŸèƒ½ã€åŠ¨æ€feedsé…ç½®ã€å®Œæ•´é…ç½®ç”Ÿæˆ
#========================================================================================================================

name: ğŸ› ï¸ æ™ºèƒ½ç¼–è¯‘å›ºä»¶

on:
  # Webç•Œé¢è§¦å‘ï¼ˆæ¨èæ–¹å¼ï¼‰
  repository_dispatch:
    types: [web_build]
  
  # æ‰‹åŠ¨è§¦å‘ï¼ˆå¤‡ç”¨æ–¹å¼ï¼‰
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'æºç åˆ†æ”¯'
        required: true
        default: 'lede-master'
        type: choice
        options:
          - lede-master
          - openwrt-main
          - immortalwrt-master
          - Lienol-master
      target_device:
        description: 'ç›®æ ‡è®¾å¤‡'
        required: true
        default: 'x86_64'
        type: choice
        options:
          - x86_64
          - xiaomi_4a_gigabit
          - newifi_d2
          - rpi_4b
          - nanopi_r2s
          - k2p
          - ac68u
          - r7800
          - wrt3200acm
      plugins_list:
        description: 'æ’ä»¶åˆ—è¡¨ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰'
        required: false
        default: ''
        type: string
      build_description:
        description: 'ç¼–è¯‘æè¿°'
        required: false
        default: 'æ‰‹åŠ¨è§¦å‘ç¼–è¯‘'
        type: string

# ç¯å¢ƒå˜é‡
env:
  TZ: Asia/Shanghai
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  UPLOAD_WETRANSFER: false
  UPLOAD_ANON: false
  CACHE_TOOLCHAIN: true

jobs:
  # é¢„å¤„ç†ä»»åŠ¡ - æ•´åˆè„šæœ¬åŠŸèƒ½
  prepare:
    runs-on: ubuntu-24.04
    name: ğŸ“‹ å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
    outputs:
      source_branch: ${{ steps.config.outputs.source_branch }}
      target_device: ${{ steps.config.outputs.target_device }}
      plugins_list: ${{ steps.config.outputs.plugins_list }}
      build_description: ${{ steps.config.outputs.build_description }}
      repo_url: ${{ steps.config.outputs.repo_url }}
      repo_branch: ${{ steps.config.outputs.repo_branch }}
      source_name: ${{ steps.config.outputs.source_name }}
      device_name: ${{ steps.config.outputs.device_name }}
      device_profile: ${{ steps.config.outputs.device_profile }}
      device_target: ${{ steps.config.outputs.device_target }}
      build_tag: ${{ steps.config.outputs.build_tag }}
      cache_key: ${{ steps.config.outputs.cache_key }}
      config_file: ${{ steps.config.outputs.config_file }}
      feeds_conf: ${{ steps.config.outputs.feeds_conf }}
      complete_config: ${{ steps.config.outputs.complete_config }}

    steps:
      - name: ğŸš€ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ åˆå§‹åŒ–ç®¡ç†è„šæœ¬
        run: |
          echo "ğŸ”§ åˆå§‹åŒ–é…ç½®ç®¡ç†å’Œæ’ä»¶æ•°æ®åº“..."

          # åˆ›å»ºå·¥ä½œç›®å½•
          echo "ğŸ“ åˆ›å»ºå·¥ä½œç›®å½•..."
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir
          
          
          # ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
          chmod +x script/*.sh
          
          # æ£€æŸ¥å¹¶å®‰è£…jqå·¥å…·ï¼ˆç”¨äºJSONå¤„ç†ï¼‰
          if ! command -v jq &> /dev/null; then
            echo "ğŸ“¦ å®‰è£…jqå·¥å…·..."
            sudo apt-get update -qq
            sudo apt-get install -y jq
          fi
          
          # åˆå§‹åŒ–é…ç½®ç®¡ç†
          echo "ğŸ”§ åˆå§‹åŒ–é…ç½®ç®¡ç†..."
          ./script/config-manager.sh init
          
          # åˆå§‹åŒ–æ’ä»¶æ•°æ®åº“
          echo "ğŸ”§ åˆå§‹åŒ–æ’ä»¶æ•°æ®åº“..."
          ./script/plugin-manager.sh init

           
          echo "âœ… ç®¡ç†è„šæœ¬åˆå§‹åŒ–å®Œæˆ"

      - name: ğŸ”§ è§£æç¼–è¯‘é…ç½®
        id: config
        run: |
          echo "ğŸ“‹ è§£æç¼–è¯‘é…ç½®..."
          
          # æ ¹æ®è§¦å‘æ–¹å¼è·å–é…ç½®å‚æ•°
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "ğŸŒ æ£€æµ‹åˆ°Webç•Œé¢è§¦å‘çš„ç¼–è¯‘è¯·æ±‚"
            SOURCE_BRANCH="${{ github.event.client_payload.source_branch }}"
            TARGET_DEVICE="${{ github.event.client_payload.target_device }}"
            PLUGINS_LIST="${{ github.event.client_payload.plugins }}"
            BUILD_DESC="Webç•Œé¢ç¼–è¯‘"
          else
            echo "ğŸ–±ï¸ æ£€æµ‹åˆ°æ‰‹åŠ¨è§¦å‘çš„ç¼–è¯‘è¯·æ±‚"
            SOURCE_BRANCH="${{ github.event.inputs.source_branch }}"
            TARGET_DEVICE="${{ github.event.inputs.target_device }}"
            PLUGINS_LIST="${{ github.event.inputs.plugins_list }}"
            BUILD_DESC="${{ github.event.inputs.build_description }}"
          fi
          
          # è®¾ç½®é»˜è®¤å€¼
          SOURCE_BRANCH=${SOURCE_BRANCH:-"lede-master"}
          TARGET_DEVICE=${TARGET_DEVICE:-"x86_64"}
          PLUGINS_LIST=${PLUGINS_LIST:-""}
          BUILD_DESC=${BUILD_DESC:-"æ™ºèƒ½ç¼–è¯‘"}
          
          echo "ğŸ“‹ ç¼–è¯‘é…ç½®ä¿¡æ¯:"
          echo "  æºç åˆ†æ”¯: $SOURCE_BRANCH"
          echo "  ç›®æ ‡è®¾å¤‡: $TARGET_DEVICE"
          echo "  æ’ä»¶åˆ—è¡¨: $PLUGINS_LIST"
          echo "  ç¼–è¯‘æè¿°: $BUILD_DESC"
          
          # æ ¹æ®æºç åˆ†æ”¯è®¾ç½®ä»“åº“ä¿¡æ¯
          case $SOURCE_BRANCH in
            "openwrt-main")
              REPO_URL="https://github.com/openwrt/openwrt"
              REPO_BRANCH="main"
              SOURCE_NAME="OpenWrtå®˜æ–¹"
              ;;
            "lede-master")
              REPO_URL="https://github.com/coolsnowwolf/lede"
              REPO_BRANCH="master"
              SOURCE_NAME="Lean's LEDE"
              ;;
            "immortalwrt-master")
              REPO_URL="https://github.com/immortalwrt/immortalwrt"
              REPO_BRANCH="master"
              SOURCE_NAME="ImmortalWrt"
              ;;
            "Lienol-master")
              REPO_URL="https://github.com/Lienol/openwrt"
              REPO_BRANCH="master"
              SOURCE_NAME="Lienol's OpenWrt"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„æºç åˆ†æ”¯: $SOURCE_BRANCH"
              exit 1
              ;;
          esac
          
          # æ ¹æ®ç›®æ ‡è®¾å¤‡è®¾ç½®è®¾å¤‡ä¿¡æ¯
          case $TARGET_DEVICE in
            "x86_64")
              DEVICE_NAME="X86_64è™šæ‹Ÿæœº"
              DEVICE_PROFILE="generic"
              DEVICE_TARGET="x86/64"
              ;;
            "xiaomi_4a_gigabit")
              DEVICE_NAME="å°ç±³è·¯ç”±å™¨4Aåƒå…†ç‰ˆ"
              DEVICE_PROFILE="xiaomi_mi-router-4a-gigabit"
              DEVICE_TARGET="ramips/mt7621"
              ;;
            "newifi_d2")
              DEVICE_NAME="æ–°è·¯ç”±3"
              DEVICE_PROFILE="d-team_newifi-d2"
              DEVICE_TARGET="ramips/mt7621"
              ;;
            "rpi_4b")
              DEVICE_NAME="æ ‘è“æ´¾4B"
              DEVICE_PROFILE="rpi-4"
              DEVICE_TARGET="bcm27xx/bcm2711"
              ;;
            "nanopi_r2s")
              DEVICE_NAME="NanoPi R2S"
              DEVICE_PROFILE="friendlyarm_nanopi-r2s"
              DEVICE_TARGET="rockchip/armv8"
              ;;
            "k2p")
              DEVICE_NAME="æ–è®¯K2P"
              DEVICE_PROFILE="phicomm_k2p"
              DEVICE_TARGET="ramips/mt7621"
              ;;
            "ac68u")
              DEVICE_NAME="åç¡•AC68U"
              DEVICE_PROFILE="asus_rt-ac68u"
              DEVICE_TARGET="bcm47xx/mips74k"
              ;;
            "r7800")
              DEVICE_NAME="ç½‘ä»¶R7800"
              DEVICE_PROFILE="netgear_r7800"
              DEVICE_TARGET="ipq806x/generic"
              ;;
            "wrt3200acm")
              DEVICE_NAME="é¢†åŠ¿WRT3200ACM"
              DEVICE_PROFILE="linksys_wrt3200acm"
              DEVICE_TARGET="mvebu/cortexa9"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„ç›®æ ‡è®¾å¤‡: $TARGET_DEVICE"
              exit 1
              ;;
          esac
          
          # ç”Ÿæˆæ„å»ºæ ‡ç­¾
          BUILD_TAG="${SOURCE_NAME}_${DEVICE_NAME}_$(date +'%Y%m%d_%H%M')"
          
          # ç”Ÿæˆç¼“å­˜é”®
          CACHE_KEY="toolchain-${SOURCE_BRANCH}-${DEVICE_TARGET//\//_}-$(date +'%Y%m%d')"
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "source_branch=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
          echo "target_device=$TARGET_DEVICE" >> $GITHUB_OUTPUT
          echo "plugins_list=$PLUGINS_LIST" >> $GITHUB_OUTPUT
          echo "build_description=$BUILD_DESC" >> $GITHUB_OUTPUT
          echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT
          echo "repo_branch=$REPO_BRANCH" >> $GITHUB_OUTPUT
          echo "source_name=$SOURCE_NAME" >> $GITHUB_OUTPUT
          echo "device_name=$DEVICE_NAME" >> $GITHUB_OUTPUT
          echo "device_profile=$DEVICE_PROFILE" >> $GITHUB_OUTPUT
          echo "device_target=$DEVICE_TARGET" >> $GITHUB_OUTPUT
          echo "build_tag=$BUILD_TAG" >> $GITHUB_OUTPUT
          echo "cache_key=$CACHE_KEY" >> $GITHUB_OUTPUT
          
          echo "âœ… é…ç½®è§£æå®Œæˆ"

      - name: ğŸ”§ ç”ŸæˆåŠ¨æ€Feedsé…ç½®
        id: feeds
        run: |
          echo "ğŸ“‹ æ ¹æ®æ’ä»¶åˆ—è¡¨ç”Ÿæˆfeedsé…ç½®..."
          
          # éªŒè¯æ’ä»¶åˆ—è¡¨ï¼ˆå¦‚æœæä¾›äº†æ’ä»¶ï¼‰
          if [ -n "${{ steps.config.outputs.plugins_list }}" ]; then
            echo "ğŸ” éªŒè¯æ’ä»¶é…ç½®..."
            if ! ./script/plugin-manager.sh validate -l "${{ steps.config.outputs.plugins_list }}"; then
              echo "âŒ æ’ä»¶éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ’ä»¶åç§°"
              exit 1
            fi
            
            echo "âš ï¸ æ£€æŸ¥æ’ä»¶å†²çª..."
            if ! ./script/plugin-manager.sh conflicts -l "${{ steps.config.outputs.plugins_list }}"; then
              echo "âŒ æ£€æµ‹åˆ°æ’ä»¶å†²çªï¼Œè¯·ä¿®æ”¹æ’ä»¶é€‰æ‹©"
              exit 1
            fi
            
            echo "ğŸ“¦ ç”Ÿæˆfeedsé…ç½®..."
            ./script/manage-feeds.sh "${{ steps.config.outputs.plugins_list }}" feeds.conf.default
            echo "âœ… å·²ç”ŸæˆåŒ…å«æ’ä»¶ä¾èµ–çš„feedsé…ç½®"
          else
            echo "ğŸ“‹ ä½¿ç”¨é»˜è®¤feedsé…ç½®"
            # æ ¹æ®æºç åˆ†æ”¯åˆ›å»ºåŸºç¡€feedsé…ç½®
            case "${{ steps.config.outputs.source_branch }}" in
              "openwrt-main")
                cat > feeds.conf.default << 'EOF'
          src-git packages https://git.openwrt.org/feed/packages.git
          src-git luci https://git.openwrt.org/project/luci.git
          src-git routing https://git.openwrt.org/feed/routing.git
          src-git telephony https://git.openwrt.org/feed/telephony.git
          EOF
                ;;
              "lede-master")
                cat > feeds.conf.default << 'EOF'
          src-git packages https://github.com/coolsnowwolf/packages
          src-git luci https://github.com/coolsnowwolf/luci
          src-git routing https://git.openwrt.org/feed/routing.git
          src-git telephony https://git.openwrt.org/feed/telephony.git
          src-git freifunk https://github.com/freifunk/openwrt-packages.git
          EOF
                ;;
              "immortalwrt-master"|"Lienol-master")
                cat > feeds.conf.default << 'EOF'
          src-git packages https://github.com/immortalwrt/packages.git
          src-git luci https://github.com/immortalwrt/luci.git
          src-git routing https://git.openwrt.org/feed/routing.git
          src-git telephony https://git.openwrt.org/feed/telephony.git
          EOF
                ;;
            esac
          fi
          
          echo "ğŸ“‹ ç”Ÿæˆçš„feedsé…ç½®:"
          cat feeds.conf.default
          
          # è®¾ç½®è¾“å‡º
          echo "feeds_conf=feeds.conf.default" >> $GITHUB_OUTPUT

      - name: ğŸ”§ ç”Ÿæˆå®Œæ•´ç¼–è¯‘é…ç½®
        id: complete_config
        run: |
          echo "ğŸ“‹ ç”Ÿæˆå®Œæ•´çš„ç¼–è¯‘é…ç½®æ–‡ä»¶..."
          
          # åˆ›å»ºå®Œæ•´çš„configæ–‡ä»¶
          cat > .config << EOF
          # ç›®æ ‡å¹³å°é…ç½®
          CONFIG_TARGET_$(echo "${{ steps.config.outputs.device_target }}" | cut -d'/' -f1)=y
          CONFIG_TARGET_$(echo "${{ steps.config.outputs.device_target }}" | sed 's/\//_/g')=y
          CONFIG_TARGET_$(echo "${{ steps.config.outputs.device_target }}" | sed 's/\//_/g')_DEVICE_${{ steps.config.outputs.device_profile }}=y
          
          # è®¾å¤‡ä¿¡æ¯é…ç½®
          CONFIG_TARGET_BOARD="$(echo "${{ steps.config.outputs.device_target }}" | cut -d'/' -f1)"
          CONFIG_TARGET_SUBTARGET="$(echo "${{ steps.config.outputs.device_target }}" | cut -d'/' -f2)"
          CONFIG_TARGET_PROFILE="${{ steps.config.outputs.device_profile }}"
          CONFIG_TARGET_ARCH_PACKAGES="$(echo "${{ steps.config.outputs.device_target }}" | cut -d'/' -f1)"
          
          # æ ¹æ–‡ä»¶ç³»ç»Ÿé…ç½®
          CONFIG_TARGET_ROOTFS_EXT4FS=y
          CONFIG_TARGET_ROOTFS_SQUASHFS=y
          CONFIG_TARGET_IMAGES_GZIP=y
          CONFIG_TARGET_KERNEL_PARTSIZE=32
          CONFIG_TARGET_ROOTFS_PARTSIZE=512
          
          # é•œåƒç”Ÿæˆå™¨é…ç½®
          CONFIG_IB=y
          CONFIG_IB_STANDALONE=y
          CONFIG_IMAGEOPT=y
          CONFIG_VERSIONOPT=y
          CONFIG_VERSION_FILENAMES=y
          
          # åŸºç¡€ç³»ç»ŸåŒ…
          CONFIG_PACKAGE_base-files=y
          CONFIG_PACKAGE_busybox=y
          CONFIG_PACKAGE_ca-bundle=y
          CONFIG_PACKAGE_ca-certificates=y
          CONFIG_PACKAGE_dnsmasq-full=y
          CONFIG_PACKAGE_dropbear=y
          CONFIG_PACKAGE_firewall4=y
          CONFIG_PACKAGE_fstools=y
          CONFIG_PACKAGE_jsonfilter=y
          CONFIG_PACKAGE_logd=y
          CONFIG_PACKAGE_mtd=y
          CONFIG_PACKAGE_netifd=y
          CONFIG_PACKAGE_openwrt-keyring=y
          CONFIG_PACKAGE_procd=y
          CONFIG_PACKAGE_procd-ujail=y
          CONFIG_PACKAGE_uci=y
          CONFIG_PACKAGE_uclient-fetch=y
          CONFIG_PACKAGE_urandom-seed=y
          CONFIG_PACKAGE_urngd=y
          
          # å†…æ ¸æ¨¡å—
          CONFIG_PACKAGE_kmod-lib-crc-ccitt=y
          CONFIG_PACKAGE_kmod-lib-crc16=y
          CONFIG_PACKAGE_kmod-nf-conntrack=y
          CONFIG_PACKAGE_kmod-nf-conntrack6=y
          CONFIG_PACKAGE_kmod-nf-nat=y
          CONFIG_PACKAGE_kmod-nf-reject=y
          CONFIG_PACKAGE_kmod-nf-reject6=y
          CONFIG_PACKAGE_kmod-nft-core=y
          CONFIG_PACKAGE_kmod-nft-fib=y
          CONFIG_PACKAGE_kmod-nft-nat=y
          CONFIG_PACKAGE_kmod-nft-offload=y
          CONFIG_PACKAGE_kmod-slhc=y
          
          # LuCI Webç•Œé¢
          CONFIG_PACKAGE_luci=y
          CONFIG_PACKAGE_luci-ssl-openssl=y
          CONFIG_PACKAGE_luci-app-firewall=y
          CONFIG_PACKAGE_luci-app-opkg=y
          CONFIG_PACKAGE_luci-mod-admin-full=y
          CONFIG_PACKAGE_luci-mod-network=y
          CONFIG_PACKAGE_luci-mod-status=y
          CONFIG_PACKAGE_luci-mod-system=y
          CONFIG_PACKAGE_luci-proto-ipv6=y
          CONFIG_PACKAGE_luci-proto-ppp=y
          CONFIG_PACKAGE_luci-theme-bootstrap=y
          
          # ç½‘ç»œå·¥å…·
          CONFIG_PACKAGE_wget-ssl=y
          CONFIG_PACKAGE_curl=y
          CONFIG_PACKAGE_ip-full=y
          CONFIG_PACKAGE_iptables-nft=y
          CONFIG_PACKAGE_kmod-ipt-core=y
          CONFIG_PACKAGE_kmod-ipt-nat=y
          
          # ç³»ç»Ÿå·¥å…·
          CONFIG_PACKAGE_htop=y
          CONFIG_PACKAGE_nano=y
          CONFIG_PACKAGE_tree=y
          CONFIG_PACKAGE_vim=y
          CONFIG_PACKAGE_bash=y
          
          # SSLæ”¯æŒ
          CONFIG_PACKAGE_libopenssl=y
          CONFIG_PACKAGE_openssl-util=y
          
          # é’ˆå¯¹ä¸åŒè®¾å¤‡çš„ç‰¹æ®Šé…ç½®
          EOF
          
          # æ ¹æ®è®¾å¤‡ç±»å‹æ·»åŠ ç‰¹æ®Šé…ç½®
          case "${{ steps.config.outputs.target_device }}" in
            "x86_64")
              cat >> .config << 'EOF'
          # X86_64 ç‰¹æ®Šé…ç½®
          CONFIG_PACKAGE_kmod-usb-core=y
          CONFIG_PACKAGE_kmod-usb-storage=y
          CONFIG_PACKAGE_kmod-usb2=y
          CONFIG_PACKAGE_kmod-usb3=y
          CONFIG_PACKAGE_block-mount=y
          CONFIG_PACKAGE_kmod-fs-ext4=y
          CONFIG_PACKAGE_kmod-fs-vfat=y
          CONFIG_PACKAGE_kmod-nls-cp437=y
          CONFIG_PACKAGE_kmod-nls-iso8859-1=y
          CONFIG_PACKAGE_kmod-nls-utf8=y
          EOF
              ;;
            "rpi_4b")
              cat >> .config << 'EOF'
          # æ ‘è“æ´¾4B ç‰¹æ®Šé…ç½®
          CONFIG_PACKAGE_kmod-brcmfmac=y
          CONFIG_PACKAGE_kmod-cfg80211=y
          CONFIG_PACKAGE_wpad-basic-wolfssl=y
          CONFIG_PACKAGE_wireless-regdb=y
          EOF
              ;;
            *)
              cat >> .config << 'EOF'
          # è·¯ç”±å™¨è®¾å¤‡é€šç”¨é…ç½®
          CONFIG_PACKAGE_wpad-basic-wolfssl=y
          CONFIG_PACKAGE_wireless-regdb=y
          CONFIG_PACKAGE_kmod-cfg80211=y
          EOF
              ;;
          esac
          
          # å¦‚æœæœ‰æ’ä»¶åˆ—è¡¨ï¼Œæ·»åŠ æ’ä»¶é…ç½®
          if [ -n "${{ steps.config.outputs.plugins_list }}" ]; then
            echo "# ç”¨æˆ·é€‰æ‹©çš„æ’ä»¶" >> .config
            IFS=',' read -ra PLUGINS <<< "${{ steps.config.outputs.plugins_list }}"
            for plugin in "${PLUGINS[@]}"; do
              plugin=$(echo "$plugin" | xargs) # å»é™¤ç©ºæ ¼
              if [ -n "$plugin" ]; then
                echo "CONFIG_PACKAGE_${plugin}=y" >> .config
              fi
            done
          fi
          
          echo "âœ… å®Œæ•´é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆ"
          echo "ğŸ“‹ é…ç½®æ–‡ä»¶é¢„è§ˆ:"
          head -20 .config
          echo "... (æ›´å¤šé…ç½®) ..."
          
          # è®¾ç½®è¾“å‡º
          echo "complete_config=.config" >> $GITHUB_OUTPUT

  # ä¸»ç¼–è¯‘ä»»åŠ¡
  build:
    runs-on: ubuntu-24.04
    name: ğŸ”¨ ç¼–è¯‘å›ºä»¶ [${{ needs.prepare.outputs.source_name }}][${{ needs.prepare.outputs.device_name }}]
    needs: prepare
    if: needs.prepare.result == 'success'
    
    steps:
      - name: ğŸš€ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "ğŸ”§ æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨..."
          sudo -E apt-get -qq update
          
          echo "ğŸ”§ å®‰è£…ç¼–è¯‘ä¾èµ–..."
          sudo -E apt-get -qq install ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
            git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
            libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz \
            mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python3 python3-pyelftools \
            libpython3-dev qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip \
            vim wget xmlto xxd zlib1g-dev python3-setuptools
          
          echo "ğŸ”§ æ¸…ç†APTç¼“å­˜..."
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          
          echo "ğŸ”§ è®¾ç½®æ—¶åŒº..."
          sudo timedatectl set-timezone "$TZ"

      - name: ğŸ“¦ å…‹éš†æºç 
        id: codes
        working-directory: /workdir
        run: |
          echo "ğŸ“¥ ä¸‹è½½æºç : ${{ needs.prepare.outputs.repo_url }}"
          echo "ğŸ“¥ åˆ†æ”¯: ${{ needs.prepare.outputs.repo_branch }}"
          
          git clone ${{ needs.prepare.outputs.repo_url }} -b ${{ needs.prepare.outputs.repo_branch }} openwrt
          
          # é“¾æ¥åˆ°å½“å‰ç›®å½•
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
          
          cd openwrt
          echo "ğŸ“‹ æºç ä¿¡æ¯:"
          echo "  æäº¤ID: $(git rev-parse HEAD)"
          echo "  æäº¤æ—¶é—´: $(git log -1 --format=%cd)"
          echo "  æäº¤ä¿¡æ¯: $(git log -1 --format=%s)"

      - name: ğŸ”§ å¤åˆ¶é…ç½®æ–‡ä»¶
        run: |
          echo "ğŸ”§ å¤åˆ¶feedsé…ç½®æ–‡ä»¶..."
          cp feeds.conf.default openwrt/feeds.conf.default
          
          echo "ğŸ”§ å¤åˆ¶ç¼–è¯‘é…ç½®æ–‡ä»¶..."
          cp .config openwrt/.config
          
          echo "ğŸ“‹ å½“å‰feedsé…ç½®:"
          cat openwrt/feeds.conf.default

      - name: ğŸ”§ ç¬¬ä¸€é˜¶æ®µè‡ªå®šä¹‰è„šæœ¬
        run: |
          echo "ğŸ”§ æ‰§è¡Œç¬¬ä¸€é˜¶æ®µè‡ªå®šä¹‰è„šæœ¬..."
          cd openwrt
          
          # æ ¹æ®æºç åˆ†æ”¯æ‰§è¡Œç›¸åº”çš„è‡ªå®šä¹‰æ“ä½œ
          case "${{ needs.prepare.outputs.source_branch }}" in
            "openwrt-main")
              echo "ğŸ”§ OpenWrtå®˜æ–¹æºç è‡ªå®šä¹‰é…ç½®..."
              # åˆ é™¤å¯èƒ½å†²çªçš„åŒ…
              rm -rf package/utils/{ucode,fbtest} || true
              ;;
            "lede-master")
              echo "ğŸ”§ Lean's LEDEæºç è‡ªå®šä¹‰é…ç½®..."
              # åˆ é™¤å¯èƒ½å†²çªçš„åŒ…
              rm -rf package/lean/{samba4,luci-app-samba4,luci-app-ttyd} || true
              ;;
            "immortalwrt-master")
              echo "ğŸ”§ ImmortalWrtæºç è‡ªå®šä¹‰é…ç½®..."
              # åˆ é™¤å¯èƒ½å†²çªçš„åŒ…
              rm -rf package/emortal/{autosamba,ipv6-helper} || true
              ;;
            "Lienol-master")
              echo "ğŸ”§ Lienolæºç è‡ªå®šä¹‰é…ç½®..."
              # æ·»åŠ ç‰¹å®šé…ç½®
              ;;
          esac
          
          # å¦‚æœæœ‰æ’ä»¶ï¼Œå¯èƒ½éœ€è¦æ·»åŠ é¢å¤–çš„feedsæºï¼ˆå·²åœ¨feedsé…ç½®ä¸­å¤„ç†ï¼‰
          echo "âœ… ç¬¬ä¸€é˜¶æ®µè‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå®Œæˆ"

      - name: ğŸ“¦ æ›´æ–°feeds
        run: |
          cd openwrt
          echo "ğŸ“¦ æ›´æ–°feeds..."
          ./scripts/feeds update -a
          
          echo "ğŸ“¦ å®‰è£…feeds..."
          ./scripts/feeds install -a

      - name: ğŸ”§ ç¬¬äºŒé˜¶æ®µè‡ªå®šä¹‰è„šæœ¬
        run: |
          echo "ğŸ”§ æ‰§è¡Œç¬¬äºŒé˜¶æ®µè‡ªå®šä¹‰è„šæœ¬..."
          cd openwrt
          
          # ä¿®æ”¹é»˜è®¤IPåœ°å€ï¼ˆæ ¹æ®è®¾å¤‡ç±»å‹å¯èƒ½éœ€è¦ä¸åŒé…ç½®ï¼‰
          case "${{ needs.prepare.outputs.target_device }}" in
            "x86_64")
              echo "ğŸ”§ é…ç½®X86è®¾å¤‡é»˜è®¤å‚æ•°..."
              sed -i 's/192.168.1.1/192.168.50.1/g' package/base-files/files/bin/config_generate || true
              ;;
            *)
              echo "ğŸ”§ é…ç½®è·¯ç”±å™¨è®¾å¤‡é»˜è®¤å‚æ•°..."
              # ä¿æŒé»˜è®¤IP 192.168.1.1 å¯¹äºè·¯ç”±å™¨è®¾å¤‡é€šå¸¸æ›´åˆé€‚
              ;;
          esac
          
          # ä¿®æ”¹é»˜è®¤ä¸»æœºå
          sed -i "s/OpenWrt/${{ needs.prepare.outputs.device_name }}/g" package/base-files/files/bin/config_generate || true
          
          # ä¿®æ”¹æ—¶åŒº
          sed -i "s/'UTC'/'CST-8'/g" package/base-files/files/bin/config_generate || true
          
          echo "âœ… ç¬¬äºŒé˜¶æ®µè‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå®Œæˆ"

      - name: ğŸ“‹ ç”Ÿæˆé…ç½®
        run: |
          cd openwrt
          echo "ğŸ“‹ ç”Ÿæˆæœ€ç»ˆé…ç½®..."
          make defconfig
          
          echo "ğŸ“‹ é…ç½®å·®å¼‚å¯¹æ¯”:"
          ./scripts/diffconfig.sh || true

      - name: ğŸ“¥ ä¸‹è½½ä¾èµ–åŒ…
        run: |
          cd openwrt
          echo "ğŸ“¥ ä¸‹è½½ç¼–è¯‘ä¾èµ–åŒ…..."
          make download -j8
          
          # æ£€æŸ¥ä¸‹è½½ç»“æœ
          find dl -size -1024c -exec ls -l {} \; || true

      - name: ğŸ”¨ ç¼–è¯‘å›ºä»¶
        run: |
          cd openwrt
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
          echo "ğŸ“‹ ç¼–è¯‘ä¿¡æ¯:"
          echo "  æºç : ${{ needs.prepare.outputs.source_name }}"
          echo "  è®¾å¤‡: ${{ needs.prepare.outputs.device_name }}"
          echo "  ç›®æ ‡: ${{ needs.prepare.outputs.device_target }}"
          echo "  é…ç½®: ${{ needs.prepare.outputs.device_profile }}"
          
          make -j$(nproc) || make -j1 V=s
          
          echo "ğŸ”¨ ç¼–è¯‘å®Œæˆ"
          echo "ğŸ“‹ å›ºä»¶ä¿¡æ¯:"
          ls -la bin/targets/*/*/*

      - name: ğŸ“‹ æ•´ç†ç¼–è¯‘ç»“æœ
        run: |
          cd openwrt
          echo "ğŸ“‹ æ•´ç†ç¼–è¯‘ç»“æœ..."
          
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p ../release
          
          # å¤åˆ¶å›ºä»¶æ–‡ä»¶
          find bin/targets/ -name "*.bin" -o -name "*.img.gz" -o -name "*.vmdk" -o -name "*.vdi" | \
          while read file; do
            filename=$(basename "$file")
            # é‡å‘½åæ–‡ä»¶ï¼ŒåŒ…å«æ›´å¤šä¿¡æ¯
            new_name="${{ needs.prepare.outputs.source_branch }}_${{ needs.prepare.outputs.target_device }}_$(date +'%Y%m%d_%H%M')_${filename}"
            cp "$file" "../release/${new_name}"
            echo "âœ… å¤åˆ¶: $file -> ${new_name}"
          done
          
          # å¤åˆ¶packagesä¿¡æ¯
          find bin/targets/ -name "*.buildinfo" -o -name "*.manifest" | \
          while read file; do
            filename=$(basename "$file")
            new_name="${{ needs.prepare.outputs.source_branch }}_${{ needs.prepare.outputs.target_device }}_$(date +'%Y%m%d_%H%M')_${filename}"
            cp "$file" "../release/${new_name}"
          done
          
          # ç”Ÿæˆç¼–è¯‘ä¿¡æ¯æ–‡ä»¶
          cat > ../release/build_info.txt << EOF
          OpenWrt æ™ºèƒ½ç¼–è¯‘ä¿¡æ¯
          ====================
          ç¼–è¯‘æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')
          æºç åˆ†æ”¯: ${{ needs.prepare.outputs.source_branch }}
          æºç åç§°: ${{ needs.prepare.outputs.source_name }}
          ç›®æ ‡è®¾å¤‡: ${{ needs.prepare.outputs.device_name }}
          è®¾å¤‡é…ç½®: ${{ needs.prepare.outputs.device_profile }}
          ç›®æ ‡å¹³å°: ${{ needs.prepare.outputs.device_target }}
          ç¼–è¯‘æè¿°: ${{ needs.prepare.outputs.build_description }}
          é€‰æ‹©æ’ä»¶: ${{ needs.prepare.outputs.plugins_list }}
          æ„å»ºæ ‡ç­¾: ${{ needs.prepare.outputs.build_tag }}
          
          æºç ä¿¡æ¯:
          ä»“åº“åœ°å€: ${{ needs.prepare.outputs.repo_url }}
          åˆ†æ”¯: ${{ needs.prepare.outputs.repo_branch }}
          æäº¤ID: $(git rev-parse HEAD)
          æäº¤æ—¶é—´: $(git log -1 --format=%cd)
          æäº¤ä¿¡æ¯: $(git log -1 --format=%s)
          
          ç¼–è¯‘ç¯å¢ƒ:
          è¿è¡Œå™¨: ubuntu-24.04
          ç¼–è¯‘æ ¸å¿ƒ: $(nproc)
          å†…å­˜ä¿¡æ¯: $(free -h | head -2)
          ç£ç›˜ä¿¡æ¯: $(df -h / | tail -1)
          
          æ–‡ä»¶åˆ—è¡¨:
          $(ls -la ../release/)
          EOF
          
          echo "ğŸ“‹ ç¼–è¯‘ç»“æœæ•´ç†å®Œæˆ"
          echo "ğŸ“‚ å‘å¸ƒæ–‡ä»¶:"
          ls -la ../release/

      - name: ğŸ“¤ ä¸Šä¼ å›ºä»¶åˆ°GitHub Artifacts
        uses: actions/upload-artifact@v4
        if: env.UPLOAD_BIN_DIR == 'true' || failure()
        with:
          name: OpenWrt_firmware_${{ needs.prepare.outputs.source_branch }}_${{ needs.prepare.outputs.target_device }}_${{ github.run_number }}
          path: release/

      - name: ğŸ“‹ ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
        id: tag
        if: env.UPLOAD_RELEASE == 'true' && !failure()
        run: |
          # ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
          release_tag="${{ needs.prepare.outputs.build_tag }}"
          echo "release_tag=$release_tag" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
          if git tag -l | grep -q "^$release_tag$"; then
            echo "æ ‡ç­¾ $release_tag å·²å­˜åœ¨ï¼Œæ·»åŠ æ—¶é—´æˆ³"
            release_tag="${release_tag}_$(date +'%H%M%S')"
            echo "release_tag=$release_tag" >> $GITHUB_OUTPUT
          fi
          
          echo "ğŸ·ï¸ å‘å¸ƒæ ‡ç­¾: $release_tag"

      - name: ğŸš€ å‘å¸ƒå›ºä»¶åˆ°Releases
        uses: softprops/action-gh-release@v1
        if: env.UPLOAD_RELEASE == 'true' && !failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          name: ${{ needs.prepare.outputs.source_name }} å›ºä»¶ [${{ needs.prepare.outputs.device_name }}] ${{ github.run_number }}
          body: |
            ## ğŸ“‹ å›ºä»¶ä¿¡æ¯
            
            **æºç åˆ†æ”¯**: ${{ needs.prepare.outputs.source_name }} (${{ needs.prepare.outputs.source_branch }})  
            **ç›®æ ‡è®¾å¤‡**: ${{ needs.prepare.outputs.device_name }} (${{ needs.prepare.outputs.target_device }})  
            **è®¾å¤‡é…ç½®**: ${{ needs.prepare.outputs.device_profile }}  
            **ç›®æ ‡å¹³å°**: ${{ needs.prepare.outputs.device_target }}  
            **ç¼–è¯‘æ—¶é—´**: ${{ env.TZ }} $(date '+%Y-%m-%d %H:%M:%S')  
            **ç¼–è¯‘æè¿°**: ${{ needs.prepare.outputs.build_description }}  
            
            ## ğŸ”Œ åŒ…å«æ’ä»¶
            
            ```
            ${{ needs.prepare.outputs.plugins_list || 'æ— é¢å¤–æ’ä»¶' }}
            ```
            
            ## ğŸ“¥ ä½¿ç”¨è¯´æ˜
            
            1. ä¸‹è½½å¯¹åº”è®¾å¤‡çš„å›ºä»¶æ–‡ä»¶
            2. é€šè¿‡è®¾å¤‡çš„åˆ·æœºæ–¹å¼åˆ·å…¥å›ºä»¶
            3. é¦–æ¬¡å¯åŠ¨åå¯é€šè¿‡Webç•Œé¢è¿›è¡Œé…ç½®
            
            ## âš ï¸ æ³¨æ„äº‹é¡¹
            
            - åˆ·æœºæœ‰é£é™©ï¼Œè¯·ç¡®ä¿äº†è§£åˆ·æœºæµç¨‹
            - å»ºè®®åˆ·æœºå‰å¤‡ä»½åŸå‚å›ºä»¶
            - å¦‚é‡é—®é¢˜è¯·æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£æˆ–æäº¤Issue
            
            ---
            
            ğŸ¤– **è‡ªåŠ¨æ„å»º** #${{ github.run_number }} | â­ **è¯·ç»™é¡¹ç›®ç‚¹ä¸ªStar!**
          files: release/*
          draft: false
          prerelease: false

      - name: ğŸ“‹ æ¸…ç†å·¥ä½œç©ºé—´
        if: always()
        run: |
          echo "ğŸ“‹ æ¸…ç†ç¼–è¯‘ç¼“å­˜..."
          if [ -d openwrt ]; then
            cd openwrt
            rm -rf tmp/ staging_dir/host*/stamp .config* || true
            cd ..
          else
            echo "âš ï¸ openwrt ç›®å½•ä¸å­˜åœ¨ï¼Œè·³è¿‡æ¸…ç†"
          fi

          echo "ğŸ“‹ æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ..."
          df -h

  # åå¤„ç†ä»»åŠ¡
  post-process:
    runs-on: ubuntu-24.04
    name: ğŸ“‹ åå¤„ç†ä»»åŠ¡
    needs: [prepare, build]
    if: always()
    
    steps:
      - name: ğŸ“Š ç¼–è¯‘ç»“æœç»Ÿè®¡
        run: |
          echo "ğŸ“Š ç¼–è¯‘ç»“æœç»Ÿè®¡"
          echo "=================="
          echo "æºç åˆ†æ”¯: ${{ needs.prepare.outputs.source_name }}"
          echo "ç›®æ ‡è®¾å¤‡: ${{ needs.prepare.outputs.device_name }}"
          echo "ç¼–è¯‘çŠ¶æ€: ${{ needs.build.result }}"
          echo "å¼€å§‹æ—¶é—´: ${{ github.event.head_commit.timestamp }}"
          echo "ç»“æŸæ—¶é—´: $(date -u '+%Y-%m-%dT%H:%M:%SZ')"
          
          if [[ "${{ needs.build.result }}" == "success" ]]; then
            echo "âœ… ç¼–è¯‘æˆåŠŸå®Œæˆï¼"
            echo "ğŸ‰ å›ºä»¶å·²å‘å¸ƒåˆ°Releasesé¡µé¢"
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥"
            echo "ğŸ’¡ è¯·æ£€æŸ¥ç¼–è¯‘æ—¥å¿—æŸ¥æ‰¾é”™è¯¯åŸå› "
          fi
