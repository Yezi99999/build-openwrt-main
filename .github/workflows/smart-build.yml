name: ğŸš€ æ™ºèƒ½OpenWrtç¼–è¯‘

on:
  repository_dispatch:
    types: [web_build]
  workflow_dispatch:
    inputs:
      config_data:
        description: 'é…ç½®æ•°æ® (JSONæ ¼å¼)'
        required: true
        default: '{"source_branch":"openwrt-main","target_device":"x86_64","plugins":[]}'

env:
  TZ: Asia/Shanghai

jobs:
  # é…ç½®è§£æå’ŒéªŒè¯
  prepare:
    runs-on: ubuntu-latest
    outputs:
      source_branch: ${{ steps.parse.outputs.source_branch }}
      target_device: ${{ steps.parse.outputs.target_device }}
      build_config: ${{ steps.parse.outputs.build_config }}
      plugins_list: ${{ steps.parse.outputs.plugins_list }}
      build_tag: ${{ steps.parse.outputs.build_tag }}
    steps:
      - name: ğŸ“‹ è§£ææ„å»ºé…ç½®
        id: parse
        run: |
          # ä»è¾“å…¥æˆ–äº‹ä»¶ä¸­è·å–é…ç½®æ•°æ®
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            CONFIG_JSON='${{ toJson(github.event.client_payload) }}'
          else
            CONFIG_JSON='${{ github.event.inputs.config_data }}'
          fi
          
          echo "åŸå§‹é…ç½®æ•°æ®: $CONFIG_JSON"
          
          # è§£æé…ç½®å‚æ•°
          SOURCE_BRANCH=$(echo "$CONFIG_JSON" | jq -r '.source_branch // "openwrt-main"')
          TARGET_DEVICE=$(echo "$CONFIG_JSON" | jq -r '.target_device // "x86_64"')
          PLUGINS_LIST=$(echo "$CONFIG_JSON" | jq -r '.plugins // [] | join(",")')
          BUILD_ID=$(echo "$CONFIG_JSON" | jq -r '.build_id // "manual"')
          
          echo "source_branch=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
          echo "target_device=$TARGET_DEVICE" >> $GITHUB_OUTPUT
          echo "plugins_list=$PLUGINS_LIST" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆæ„å»ºæ ‡ç­¾
          TIMESTAMP=$(date '+%Y%m%d_%H%M')
          BUILD_TAG="${SOURCE_BRANCH}_${TARGET_DEVICE}_${TIMESTAMP}"
          echo "build_tag=$BUILD_TAG" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆå®Œæ•´çš„æ„å»ºé…ç½®æ–‡ä»¶
          cat > build_config.json << EOF
          {
            "source": "$SOURCE_BRANCH",
            "device": "$TARGET_DEVICE", 
            "plugins": $(echo "$CONFIG_JSON" | jq '.plugins // []'),
            "custom_sources": $(echo "$CONFIG_JSON" | jq '.custom_sources // []'),
            "build_time": "$(date '+%Y-%m-%d %H:%M:%S')",
            "build_id": "$BUILD_ID",
            "build_tag": "$BUILD_TAG"
          }
          EOF
          
          BUILD_CONFIG=$(cat build_config.json | jq -c .)
          echo "build_config=$BUILD_CONFIG" >> $GITHUB_OUTPUT
          
          echo "âœ… é…ç½®è§£æå®Œæˆ"
          echo "ğŸ“¦ æºç åˆ†æ”¯: $SOURCE_BRANCH"
          echo "ğŸ¯ ç›®æ ‡è®¾å¤‡: $TARGET_DEVICE"
          echo "ğŸ”§ æ’ä»¶æ•°é‡: $(echo "$CONFIG_JSON" | jq '.plugins | length')"

      - name: â¬†ï¸ ä¸Šä¼ é…ç½®æ–‡ä»¶
        uses: actions/upload-artifact@v3
        with:
          name: build-config-${{ steps.parse.outputs.build_tag }}
          path: build_config.json

  # ä¾èµ–å†²çªæ£€æŸ¥
  validate:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: ğŸ“¥ ä¸‹è½½é…ç½®æ–‡ä»¶
        uses: actions/download-artifact@v3
        with:
          name: build-config-${{ needs.prepare.outputs.build_tag }}

      - name: ğŸ” ä¾èµ–å†²çªæ£€æŸ¥
        run: |
          echo "ğŸ” å¼€å§‹ä¾èµ–å†²çªæ£€æŸ¥..."
          
          # åˆ›å»ºå†²çªæ£€æŸ¥è„šæœ¬
          cat > conflict_check.py << 'EOF'
          import json
          import sys
          import re
          
          # åŠ è½½é…ç½®
          with open('build_config.json', 'r') as f:
              config = json.load(f)
          
          plugins = config.get('plugins', [])
          device = config.get('device', '')
          source = config.get('source', '')
          
          print(f"âœ… æ£€æŸ¥è®¾å¤‡: {device}")
          print(f"âœ… æ£€æŸ¥æºç : {source}")
          print(f"âœ… æ£€æŸ¥æ’ä»¶: {len(plugins)} ä¸ª")
          
          if plugins:
              print("é€‰ä¸­çš„æ’ä»¶:")
              for plugin in plugins:
                  print(f"  - {plugin}")
          
          # å†²çªæ£€æŸ¥è§„åˆ™
          conflicts = []
          warnings = []
          
          # 1. æ£€æŸ¥äº’æ–¥æ’ä»¶ç»„
          mutex_groups = [
              {
                  'name': 'ç§‘å­¦ä¸Šç½‘å·¥å…·',
                  'plugins': ['ssr-plus', 'passwall', 'openclash', 'v2raya']
              },
              {
                  'name': 'å¹¿å‘Šæ‹¦æˆªå·¥å…·',
                  'plugins': ['adbyby-plus', 'adguardhome']
              },
              {
                  'name': 'BTä¸‹è½½å·¥å…·',
                  'plugins': ['aria2', 'transmission']
              }
          ]
          
          for group in mutex_groups:
              found_plugins = []
              for plugin in plugins:
                  for mutex_plugin in group['plugins']:
                      if mutex_plugin in plugin or plugin in mutex_plugin:
                          found_plugins.append(plugin)
              
              if len(found_plugins) > 1:
                  conflicts.append(f"{group['name']}å†²çª: {', '.join(found_plugins)} ä¸èƒ½åŒæ—¶é€‰æ‹©")
          
          # 2. æ£€æŸ¥è®¾å¤‡å­˜å‚¨é™åˆ¶
          size_limits = {
              'xiaomi': 16,
              'phicomm': 16,
              'ramips': 16,
              'ath79': 8,
              'x86': 999,
              'raspberry': 999
          }
          
          device_type = 'x86'  # é»˜è®¤
          for key in size_limits.keys():
              if key in device.lower():
                  device_type = key
                  break
          
          limit = size_limits.get(device_type, 16)
          
          # ä¼°ç®—æ’ä»¶å¤§å°ï¼ˆç®€åŒ–è®¡ç®—ï¼‰
          large_plugins = ['docker', 'nextcloud', 'kodexplorer', 'adguardhome']
          total_size = 0
          
          for plugin in plugins:
              if any(large in plugin for large in large_plugins):
                  if 'docker' in plugin:
                      total_size += 20
                  elif 'nextcloud' in plugin or 'kodexplorer' in plugin:
                      total_size += 15
                  elif 'adguardhome' in plugin:
                      total_size += 8
                  else:
                      total_size += 3
              else:
                  total_size += 1
          
          if total_size > limit and device_type != 'x86':
              warnings.append(f"æ’ä»¶æ€»å¤§å°çº¦ {total_size}MBï¼Œå¯èƒ½è¶…å‡ºè®¾å¤‡å­˜å‚¨é™åˆ¶ {limit}MB")
          
          # 3. æ£€æŸ¥æ¶æ„å…¼å®¹æ€§
          if device_type in ['ramips', 'ath79']:
              incompatible = [p for p in plugins if 'docker' in p or 'nextcloud' in p]
              if incompatible:
                  warnings.append(f"è®¾å¤‡æ¶æ„å¯èƒ½ä¸æ”¯æŒ: {', '.join(incompatible)}")
          
          # 4. ä¾èµ–å…³ç³»æ£€æŸ¥
          dependencies = {
              'openclash': ['iptables-mod-tproxy', 'kmod-tun'],
              'ssr-plus': ['iptables-mod-tproxy', 'dnsmasq-full'],
              'passwall': ['xray-core', 'iptables-mod-tproxy'],
              'docker': ['kmod-veth', 'kmod-bridge']
          }
          
          for plugin in plugins:
              for dep_plugin, deps in dependencies.items():
                  if dep_plugin in plugin:
                      warnings.append(f"æ’ä»¶ {plugin} éœ€è¦ä¾èµ–: {', '.join(deps)}")
          
          # è¾“å‡ºæ£€æŸ¥ç»“æœ
          print("\n" + "="*50)
          if conflicts:
              print("âŒ å‘ç°é…ç½®å†²çª:")
              for conflict in conflicts:
                  print(f"  - {conflict}")
              print("::error::å‘ç°é…ç½®å†²çªï¼Œè¯·ä¿®æ­£åé‡è¯•")
              sys.exit(1)
          else:
              print("âœ… æœªå‘ç°é…ç½®å†²çª")
          
          if warnings:
              print("âš ï¸  å‘ç°æ½œåœ¨é—®é¢˜:")
              for warning in warnings:
                  print(f"  - {warning}")
              print("::warning::å‘ç°æ½œåœ¨é—®é¢˜ï¼Œå»ºè®®æ£€æŸ¥é…ç½®")
          
          # ä¿å­˜æ£€æŸ¥ç»“æœ
          result = {
              "valid": len(conflicts) == 0,
              "conflicts": conflicts,
              "warnings": warnings,
              "device_type": device_type,
              "estimated_size": f"{total_size}MB"
          }
          
          with open('validation_result.json', 'w') as f:
              json.dump(result, f, indent=2, ensure_ascii=False)
          
          print(f"\nğŸ“Š æ£€æŸ¥å®Œæˆï¼Œä¼°ç®—å›ºä»¶å¤§å°: {total_size}MB")
          EOF
          
          python3 conflict_check.py

      - name: â¬†ï¸ ä¸Šä¼ éªŒè¯ç»“æœ
        uses: actions/upload-artifact@v3
        with:
          name: validation-result-${{ needs.prepare.outputs.build_tag }}
          path: validation_result.json

  # ä¸»ç¼–è¯‘ä»»åŠ¡
  build:
    runs-on: ubuntu-latest
    needs: [prepare, validate]
    if: always() && needs.prepare.result == 'success' && needs.validate.result == 'success'
    
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: ğŸ“¥ ä¸‹è½½é…ç½®æ–‡ä»¶
        uses: actions/download-artifact@v3
        with:
          name: build-config-${{ needs.prepare.outputs.build_tag }}

      - name: ğŸ”§ åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "ğŸ”§ å¼€å§‹åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ..."
          
          # æ¸…ç†ç³»ç»Ÿç©ºé—´ï¼Œé‡Šæ”¾æ›´å¤šå­˜å‚¨
          docker rmi `docker images -q` 2>/dev/null || true
          sudo rm -rf /usr/share/dotnet /etc/apt/sources.list.d /usr/local/lib/android 2>/dev/null || true
          sudo rm -rf /opt/ghc /usr/local/share/boost 2>/dev/null || true
          
          # æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…ä¾èµ–
          sudo -E apt-get -qq update
          sudo -E apt-get -qq install ack antlr3 aria2 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache cmake cpio curl device-tree-compiler fastjar flex gawk gettext gcc-multilib g++-multilib \
            git gperf haveged help2man intltool libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
            libmpc-dev libmpfr-dev libncurses5-dev libncursesw5-dev libreadline-dev libssl-dev libtool lrzsz \
            mkisofs msmtp nano ninja-build p7zip p7zip-full patch pkgconf python2.7 python3 python3-pip \
            qemu-utils rsync scons squashfs-tools subversion swig texinfo uglifyjs upx-ucl unzip vim wget \
            xmlto xxd zlib1g-dev
          
          # æ¸…ç†å®‰è£…ç¼“å­˜
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          
          # è®¾ç½®å·¥ä½œç›®å½•
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir
          
          echo "âœ… ç¼–è¯‘ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
          df -hT

      - name: ğŸ“¦ è·å–OpenWrtæºç 
        working-directory: /workdir
        run: |
          # è¯»å–é…ç½®
          SOURCE_BRANCH="${{ needs.prepare.outputs.source_branch }}"
          echo "ğŸ“¦ å…‹éš†æºç åˆ†æ”¯: $SOURCE_BRANCH"
          
          # æ ¹æ®åˆ†æ”¯é€‰æ‹©æºç ä»“åº“
          case "$SOURCE_BRANCH" in
            "openwrt-main")
              REPO_URL="https://github.com/openwrt/openwrt"
              REPO_BRANCH="main"
              TAGS_NAME="official"
              ;;
            "lede-master")
              REPO_URL="https://github.com/coolsnowwolf/lede"
              REPO_BRANCH="master"
              TAGS_NAME="lede"
              ;;
            "immortalwrt-master")
              REPO_URL="https://github.com/immortalwrt/immortalwrt"
              REPO_BRANCH="master"
              TAGS_NAME="immortalwrt"
              ;;
            "lienol-master")
              REPO_URL="https://github.com/Lienol/openwrt"
              REPO_BRANCH="22.03"
              TAGS_NAME="lienol"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„æºç åˆ†æ”¯: $SOURCE_BRANCH"
              exit 1
              ;;
          esac
          
          # å…‹éš†æºç ï¼ˆæµ…å…‹éš†ä»¥èŠ‚çœæ—¶é—´å’Œç©ºé—´ï¼‰
          git clone --depth 1 --branch $REPO_BRANCH $REPO_URL openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          echo "OPENWRT_ROOT=/workdir/openwrt" >> $GITHUB_ENV
          echo "SOURCE_NAME=$TAGS_NAME" >> $GITHUB_ENV
          
          echo "âœ… æºç è·å–å®Œæˆ"
          echo "ğŸ“‹ ä»“åº“ä¿¡æ¯:"
          echo "  URL: $REPO_URL"
          echo "  åˆ†æ”¯: $REPO_BRANCH"
          echo "  æ ‡ç­¾: $TAGS_NAME"

      - name: ğŸ”§ é…ç½®æ’ä»¶æº
        run: |
          cd /workdir/openwrt
          
          echo "ğŸ”§ é…ç½®æ’ä»¶æº..."
          
          # å¤‡ä»½åŸå§‹feedsé…ç½®
          cp feeds.conf.default feeds.conf.default.bak
          
          # è¯»å–è‡ªå®šä¹‰æ’ä»¶æºé…ç½®
          CUSTOM_SOURCES=$(cat $GITHUB_WORKSPACE/build_config.json | jq -r '.custom_sources[]?' 2>/dev/null || echo "")
          
          # æ ¹æ®æºç åˆ†æ”¯æ·»åŠ ç›¸åº”çš„ç¬¬ä¸‰æ–¹æ’ä»¶æº
          SOURCE_BRANCH="${{ needs.prepare.outputs.source_branch }}"
          
          if [[ "$SOURCE_BRANCH" == "lede-master" ]]; then
            echo "ğŸ“¦ ä¸ºLEDEæ·»åŠ æ’ä»¶æº..."
            cat >> feeds.conf.default << EOF
          # Lean's additional packages
          src-git kenzo https://github.com/kenzok8/openwrt-packages
          src-git small https://github.com/kenzok8/small
          EOF
          elif [[ "$SOURCE_BRANCH" == "openwrt-main" ]]; then
            echo "ğŸ“¦ ä¸ºå®˜æ–¹OpenWrtæ·»åŠ æ’ä»¶æº..."
            cat >> feeds.conf.default << EOF
          # Third-party packages for official OpenWrt
          src-git kenzo https://github.com/kenzok8/openwrt-packages
          src-git small https://github.com/kenzok8/small
          src-git luci_app_openclash https://github.com/vernesong/OpenClash
          EOF
          fi
          
          # æ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰æ’ä»¶æº
          if [ -n "$CUSTOM_SOURCES" ]; then
            echo "ğŸ“¦ æ·»åŠ è‡ªå®šä¹‰æ’ä»¶æº..."
            echo "$CUSTOM_SOURCES" | while IFS= read -r source; do
              if [ -n "$source" ]; then
                SOURCE_NAME=$(echo "$source" | sed 's/.*\///' | sed 's/\.git$//' | tr '[:upper:]' '[:lower:]')
                echo "src-git custom_$SOURCE_NAME $source" >> feeds.conf.default
                echo "  æ·»åŠ : $source"
              fi
            done
          fi
          
          echo "ğŸ“‹ æœ€ç»ˆçš„æ’ä»¶æºé…ç½®:"
          cat feeds.conf.default

      - name: ğŸ”„ æ›´æ–°å’Œå®‰è£…æ’ä»¶æº
        run: |
          cd /workdir/openwrt
          
          echo "ğŸ”„ æ›´æ–°æ’ä»¶æº..."
          ./scripts/feeds update -a
          
          echo "ğŸ“¦ å®‰è£…æ’ä»¶æº..."
          ./scripts/feeds install -a
          
          echo "âœ… æ’ä»¶æºæ›´æ–°å®Œæˆ"

      - name: âš™ï¸ ç”Ÿæˆç¼–è¯‘é…ç½®
        run: |
          cd /workdir/openwrt
          
          echo "âš™ï¸ ç”Ÿæˆç¼–è¯‘é…ç½®..."
          
          # è¯»å–æ„å»ºé…ç½®
          TARGET_DEVICE="${{ needs.prepare.outputs.target_device }}"
          PLUGINS_LIST="${{ needs.prepare.outputs.plugins_list }}"
          
          echo "ğŸ¯ ç›®æ ‡è®¾å¤‡: $TARGET_DEVICE"
          echo "ğŸ”§ é€‰ä¸­æ’ä»¶: $PLUGINS_LIST"
          
          # åˆ›å»ºé…ç½®ç”Ÿæˆè„šæœ¬
          cat > generate_config.py << 'EOF'
          import json
          import os
          import sys
          
          # è¯»å–é…ç½®æ–‡ä»¶
          config_file = '../build_config.json'
          if not os.path.exists(config_file):
              print("âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨")
              sys.exit(1)
          
          with open(config_file, 'r') as f:
              config = json.load(f)
          
          device = config.get('device', 'x86_64')
          plugins = config.get('plugins', [])
          source = config.get('source', 'openwrt-main')
          
          print(f"ğŸ¯ ç”Ÿæˆé…ç½® - è®¾å¤‡: {device}, æ’ä»¶æ•°: {len(plugins)}, æºç : {source}")
          
          # è®¾å¤‡é…ç½®æ˜ å°„
          device_configs = {
              'x86_64': {
                  'target': 'x86',
                  'subtarget': '64',
                  'profile': 'generic'
              },
              'raspberry-pi-4': {
                  'target': 'bcm27xx',
                  'subtarget': 'bcm2711',
                  'profile': 'rpi-4'
              },
              'xiaomi-4a-gigabit': {
                  'target': 'ramips',
                  'subtarget': 'mt7621',
                  'profile': 'xiaomi_mi-router-4a-gigabit'
              },
              'newifi-d2': {
                  'target': 'ramips',
                  'subtarget': 'mt7621',
                  'profile': 'lenovo_newifi-d2'
              },
              'phicomm-k2p': {
                  'target': 'ramips',
                  'subtarget': 'mt7621',
                  'profile': 'phicomm_k2p'
              },
              'linksys-wrt3200acm': {
                  'target': 'mvebu',
                  'subtarget': 'cortexa9',
                  'profile': 'linksys_wrt3200acm'
              },
              'netgear-r7800': {
                  'target': 'ipq806x',
                  'subtarget': 'generic',
                  'profile': 'netgear_r7800'
              },
              'nanopi-r2s': {
                  'target': 'rockchip',
                  'subtarget': 'armv8',
                  'profile': 'friendlyarm_nanopi-r2s'
              }
          }
          
          # è·å–è®¾å¤‡é…ç½®ï¼Œé»˜è®¤ä½¿ç”¨x86_64
          device_config = device_configs.get(device, device_configs['x86_64'])
          
          # ç”ŸæˆåŸºç¡€é…ç½®
          config_lines = [
              f"CONFIG_TARGET_{device_config['target']}=y",
              f"CONFIG_TARGET_{device_config['target']}_{device_config['subtarget']}=y",
              f"CONFIG_TARGET_{device_config['target']}_{device_config['subtarget']}_DEVICE_{device_config['profile']}=y",
              "",
              "# åŸºç¡€ç³»ç»Ÿé…ç½®",
              "CONFIG_PACKAGE_luci=y",
              "CONFIG_PACKAGE_luci-ssl=y",
              "CONFIG_PACKAGE_luci-theme-bootstrap=y",
              "CONFIG_PACKAGE_luci-app-firewall=y",
              "CONFIG_PACKAGE_luci-app-opkg=y",
              "",
              "# ç½‘ç»œåŸºç¡€ç»„ä»¶",
              "CONFIG_PACKAGE_curl=y",
              "CONFIG_PACKAGE_wget-ssl=y",
              "CONFIG_PACKAGE_ca-certificates=y",
              "CONFIG_PACKAGE_dnsmasq-full=y",
              "CONFIG_PACKAGE_iptables-mod-tproxy=y",
              "",
              "# å†…æ ¸æ¨¡å—",
              "CONFIG_PACKAGE_kmod-tun=y",
              "CONFIG_PACKAGE_kmod-inet-diag=y",
              "",
              "# ç”¨æˆ·é€‰æ‹©çš„æ’ä»¶"
          ]
          
          # æ’ä»¶åç§°æ˜ å°„
          plugin_mapping = {
              'ssr-plus': 'luci-app-ssr-plus',
              'passwall': 'luci-app-passwall',
              'openclash': 'luci-app-openclash',
              'v2raya': 'luci-app-v2raya',
              'wireguard': 'luci-app-wireguard',
              'zerotier': 'luci-app-zerotier',
              'adbyby-plus': 'luci-app-adbyby-plus',
              'adguardhome': 'luci-app-adguardhome',
              'frpc': 'luci-app-frpc',
              'ddns': 'luci-app-ddns',
              'upnp': 'luci-app-upnp',
              'mwan3': 'luci-app-mwan3',
              'docker': 'luci-app-docker',
              'ttyd': 'luci-app-ttyd',
              'webadmin': 'luci-app-webadmin',
              'wol': 'luci-app-wol',
              'nlbwmon': 'luci-app-nlbwmon',
              'aria2': 'luci-app-aria2',
              'transmission': 'luci-app-transmission',
              'minidlna': 'luci-app-minidlna',
              'samba4': 'luci-app-samba4',
              'usb-printer': 'luci-app-usb-printer',
              'kodexplorer': 'luci-app-kodexplorer',
              'nextcloud': 'luci-app-nextcloud',
              'vsftpd': 'luci-app-vsftpd'
          }
          
          # æ·»åŠ ç”¨æˆ·é€‰æ‹©çš„æ’ä»¶
          for plugin in plugins:
              mapped_plugin = plugin_mapping.get(plugin, plugin)
              if not mapped_plugin.startswith('luci-app-'):
                  mapped_plugin = f'luci-app-{mapped_plugin}'
              config_lines.append(f"CONFIG_PACKAGE_{mapped_plugin}=y")
              print(f"  âœ… æ·»åŠ æ’ä»¶: {mapped_plugin}")
          
          # ç‰¹æ®Šæ’ä»¶çš„ä¾èµ–å¤„ç†
          special_deps = {
              'luci-app-docker': [
                  'CONFIG_PACKAGE_docker=y',
                  'CONFIG_PACKAGE_dockerd=y',
                  'CONFIG_PACKAGE_docker-compose=y'
              ],
              'luci-app-adguardhome': [
                  'CONFIG_PACKAGE_adguardhome=y'
              ],
              'luci-app-aria2': [
                  'CONFIG_PACKAGE_aria2=y',
                  'CONFIG_PACKAGE_ariang=y'
              ],
              'luci-app-samba4': [
                  'CONFIG_PACKAGE_samba4-server=y',
                  'CONFIG_PACKAGE_samba4-client=y'
              ]
          }
          
          for plugin in plugins:
              mapped_plugin = plugin_mapping.get(plugin, plugin)
              if not mapped_plugin.startswith('luci-app-'):
                  mapped_plugin = f'luci-app-{mapped_plugin}'
              
              if mapped_plugin in special_deps:
                  config_lines.extend(special_deps[mapped_plugin])
                  print(f"  ğŸ”§ æ·»åŠ  {mapped_plugin} çš„ä¾èµ–åŒ…")
          
          # é’ˆå¯¹ä¸åŒæºç åˆ†æ”¯çš„ç‰¹æ®Šé…ç½®
          if source == 'lede-master':
              config_lines.extend([
                  "",
                  "# LEDEç‰¹æ®Šé…ç½®",
                  "CONFIG_PACKAGE_luci-theme-argon=y",
                  "CONFIG_PACKAGE_default-settings=y"
              ])
          
          # æ ¹æ®è®¾å¤‡ç±»å‹æ·»åŠ ç‰¹æ®Šé…ç½®
          if 'x86' in device:
              config_lines.extend([
                  "",
                  "# X86ç‰¹æ®Šé…ç½®",
                  "CONFIG_EFI_IMAGES=y",
                  "CONFIG_VDI_IMAGES=y",
                  "CONFIG_VMDK_IMAGES=y",
                  "CONFIG_TARGET_IMAGES_GZIP=y"
              ])
          elif 'raspberry' in device:
              config_lines.extend([
                  "",
                  "# æ ‘è“æ´¾ç‰¹æ®Šé…ç½®",
                  "CONFIG_PACKAGE_kmod-usb-hid=y",
                  "CONFIG_PACKAGE_kmod-sound-core=y"
              ])
          
          # å†™å…¥é…ç½®æ–‡ä»¶
          with open('.config', 'w') as f:
              f.write('\n'.join(config_lines) + '\n')
          
          print(f"âœ… é…ç½®æ–‡ä»¶ç”Ÿæˆå®Œæˆï¼Œå…± {len(config_lines)} è¡Œé…ç½®")
          EOF
          
          # æ‰§è¡Œé…ç½®ç”Ÿæˆ
          python3 generate_config.py
          
          # ç”Ÿæˆå®Œæ•´é…ç½®
          make defconfig
          
          echo "ğŸ“‹ æœ€ç»ˆç¼–è¯‘é…ç½®é¢„è§ˆ:"
          head -30 .config
          echo "..."
          echo "æ€»é…ç½®è¡Œæ•°: $(wc -l < .config)"

      - name: ğŸ“¥ ä¸‹è½½ç¼–è¯‘ä¾èµ–
        run: |
          cd /workdir/openwrt
          
          echo "ğŸ“¥ ä¸‹è½½ç¼–è¯‘ä¾èµ–åŒ…..."
          make download -j8
          
          # æ£€æŸ¥ä¸‹è½½ç»“æœ
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
          
          echo "âœ… ä¾èµ–ä¸‹è½½å®Œæˆ"

      - name: ğŸš€ å¼€å§‹ç¼–è¯‘
        run: |
          cd /workdir/openwrt
          
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ OpenWrt..."
          echo "ç¼–è¯‘å¼€å§‹æ—¶é—´: $(date)"
          echo "ç¼–è¯‘çº¿ç¨‹æ•°: $(nproc)"
          
          # è®°å½•ç¼–è¯‘å¼€å§‹æ—¶é—´
          echo "BUILD_START_TIME=$(date)" >> $GITHUB_ENV
          
          # å¼€å§‹ç¼–è¯‘
          # é¦–å…ˆå°è¯•å¤šçº¿ç¨‹ç¼–è¯‘ï¼Œå¦‚æœå¤±è´¥åˆ™å•çº¿ç¨‹é‡è¯•
          echo "ç¬¬ä¸€æ¬¡å°è¯•: å¤šçº¿ç¨‹ç¼–è¯‘"
          if ! make -j$(($(nproc) + 1)) V=s; then
            echo "âš ï¸ å¤šçº¿ç¨‹ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘"
            if ! make -j1 V=s; then
              echo "âŒ å•çº¿ç¨‹ç¼–è¯‘ä¹Ÿå¤±è´¥ï¼Œå°è¯•è¯¦ç»†æ—¥å¿—ç¼–è¯‘"
              make -j1 V=sc
            fi
          fi
          
          echo "ç¼–è¯‘ç»“æŸæ—¶é—´: $(date)"
          echo "BUILD_END_TIME=$(date)" >> $GITHUB_ENV

      - name: ğŸ“Š æ£€æŸ¥ç¼–è¯‘ç»“æœ
        run: |
          cd /workdir/openwrt
          
          echo "ğŸ“Š ç¼–è¯‘ç»“æœç»Ÿè®¡:"
          echo "å¼€å§‹æ—¶é—´: $BUILD_START_TIME"
          echo "ç»“æŸæ—¶é—´: $BUILD_END_TIME"
          
          if [ -d "bin/targets" ]; then
            echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸ"
            
            # æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶
            FIRMWARE_FILES=$(find bin/targets/ -name "*.bin" -o -name "*.img" -o -name "*.gz" | head -10)
            echo "ç¼–è¯‘ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶:"
            echo "$FIRMWARE_FILES"
            
            # ç»Ÿè®¡å›ºä»¶å¤§å°
            if [ -n "$FIRMWARE_FILES" ]; then
              FIRMWARE_SIZE=$(echo "$FIRMWARE_FILES" | head -1 | xargs ls -lh | awk '{print $5}')
              echo "FIRMWARE_SIZE=$FIRMWARE_SIZE" >> $GITHUB_ENV
              echo "ä¸»å›ºä»¶å¤§å°: $FIRMWARE_SIZE"
            fi
            
            # ç»Ÿè®¡ç¼–è¯‘äº§ç‰©
            TOTAL_FILES=$(find bin/targets/ -type f | wc -l)
            TOTAL_SIZE=$(du -sh bin/targets/ | cut -f1)
            echo "ç¼–è¯‘äº§ç‰©ç»Ÿè®¡: $TOTAL_FILES ä¸ªæ–‡ä»¶ï¼Œæ€»å¤§å° $TOTAL_SIZE"
            
          else
            echo "âŒ å›ºä»¶ç¼–è¯‘å¤±è´¥"
            echo "æ£€æŸ¥æ˜¯å¦å­˜åœ¨é”™è¯¯æ—¥å¿—..."
            if [ -f "logs/package/error.txt" ]; then
              echo "åŒ…ç¼–è¯‘é”™è¯¯:"
              cat logs/package/error.txt
            fi
            exit 1
          fi

      - name: ğŸ“¦ æ•´ç†ç¼–è¯‘äº§ç‰©
        run: |
          cd /workdir/openwrt/bin/targets/*/*
          
          echo "ğŸ“¦ æ•´ç†ç¼–è¯‘äº§ç‰©..."
          
          # åˆ é™¤ä¸éœ€è¦çš„packagesç›®å½•
          rm -rf packages
          
          # ç”Ÿæˆæ–‡ä»¶åå˜é‡
          TIMESTAMP=$(date +%Y%m%d_%H%M)
          DEVICE_NAME="${{ needs.prepare.outputs.target_device }}"
          SOURCE_NAME="${{ env.SOURCE_NAME }}"
          BUILD_TAG="${{ needs.prepare.outputs.build_tag }}"
          
          # é‡å‘½åå›ºä»¶æ–‡ä»¶ï¼Œæ·»åŠ æ›´è¯¦ç»†çš„ä¿¡æ¯
          for file in *.bin *.img *.gz; do
            if [ -f "$file" ]; then
              # æå–æ–‡ä»¶æ‰©å±•å
              EXT="${file##*.}"
              # ç”Ÿæˆæ–°æ–‡ä»¶å
              NEW_NAME="OpenWrt_${SOURCE_NAME}_${DEVICE_NAME}_${TIMESTAMP}.${EXT}"
              mv "$file" "$NEW_NAME"
              echo "ğŸ“¦ é‡å‘½å: $file -> $NEW_NAME"
            fi
          done
          
          # ç”Ÿæˆè¯¦ç»†çš„å›ºä»¶ä¿¡æ¯æ–‡ä»¶
          cat > firmware_info.txt << EOF
          OpenWrt æ™ºèƒ½ç¼–è¯‘å›ºä»¶ä¿¡æ¯
          ========================
          
          ğŸ“‹ åŸºæœ¬ä¿¡æ¯:
          ç¼–è¯‘æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
          æ„å»ºæ ‡ç­¾: $BUILD_TAG
          æºç åˆ†æ”¯: $SOURCE_NAME
          ç›®æ ‡è®¾å¤‡: $DEVICE_NAME
          å›ºä»¶å¤§å°: ${FIRMWARE_SIZE:-æœªçŸ¥}
          
          ğŸ”§ ç¼–è¯‘é…ç½®:
          é€‰ä¸­æ’ä»¶: ${{ needs.prepare.outputs.plugins_list }}
          
          ğŸ“± é»˜è®¤ä¿¡æ¯:
          - é»˜è®¤IPåœ°å€: 192.168.1.1
          - é»˜è®¤ç”¨æˆ·å: root
          - é»˜è®¤å¯†ç : password
          - é»˜è®¤WiFiå: OpenWrt (å¦‚æ”¯æŒ)
          - é»˜è®¤WiFiå¯†ç : æ— 
          
          ğŸ“– ä½¿ç”¨è¯´æ˜:
          1. åˆ·æœºå‰è¯·ç¡®è®¤è®¾å¤‡å‹å·
          2. å»ºè®®å…ˆå¤‡ä»½åŸå‚å›ºä»¶
          3. åˆ·æœºæœ‰é£é™©ï¼Œè¯·è°¨æ…æ“ä½œ
          4. å¦‚é‡é—®é¢˜å¯å°è¯•æ•‘ç –æ“ä½œ
          
          ğŸ”— ç›¸å…³é“¾æ¥:
          - é¡¹ç›®åœ°å€: https://github.com/${{ github.repository }}
          - OpenWrtå®˜ç½‘: https://openwrt.org
          - ä½¿ç”¨æ–‡æ¡£: https://github.com/${{ github.repository }}/wiki
          
          âš ï¸ å…è´£å£°æ˜:
          æœ¬å›ºä»¶ä»…ä¾›å­¦ä¹ äº¤æµä½¿ç”¨ï¼Œä½¿ç”¨è€…éœ€è‡ªè¡Œæ‰¿æ‹…åˆ·æœºé£é™©ã€‚
          EOF
          
          # ç”ŸæˆSHA256æ ¡éªŒæ–‡ä»¶
          for file in OpenWrt_*.bin OpenWrt_*.img OpenWrt_*.gz; do
            if [ -f "$file" ]; then
              sha256sum "$file" >> sha256sums.txt
              echo "ğŸ”’ ç”Ÿæˆæ ¡éªŒ: $file"
            fi
          done
          
          echo "FIRMWARE_PATH=$PWD" >> $GITHUB_ENV
          echo "âœ… ç¼–è¯‘äº§ç‰©æ•´ç†å®Œæˆ"

      - name: â¬†ï¸ ä¸Šä¼ å›ºä»¶åˆ° Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: ${{ needs.prepare.outputs.build_tag }}
          path: ${{ env.FIRMWARE_PATH }}
          retention-days: 7

      - name: ğŸ‰ ç”Ÿæˆå‘å¸ƒç‰ˆæœ¬
        id: release
        run: |
          RELEASE_TAG="${{ needs.prepare.outputs.build_tag }}"
          RELEASE_NAME="OpenWrt æ™ºèƒ½ç¼–è¯‘ - ${{ needs.prepare.outputs.target_device }} ($(date '+%Y-%m-%d %H:%M'))"
          
          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ å‘å¸ƒä¿¡æ¯:"
          echo "æ ‡ç­¾: $RELEASE_TAG"
          echo "åç§°: $RELEASE_NAME"

      - name: ğŸ“¢ å‘å¸ƒå›ºä»¶
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.release.outputs.release_tag }}
          name: ${{ steps.release.outputs.release_name }}
          body_path: ${{ env.FIRMWARE_PATH }}/firmware_info.txt
          files: |
            ${{ env.FIRMWARE_PATH }}/OpenWrt_*
            ${{ env.FIRMWARE_PATH }}/sha256sums.txt
          draft: false
          prerelease: false

      - name: ğŸ“Š ç¼–è¯‘å®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ‰ OpenWrtæ™ºèƒ½ç¼–è¯‘ä»»åŠ¡å®Œæˆ!"
          echo "ğŸ“¦ æºç : ${{ env.SOURCE_NAME }}"
          echo "ğŸ¯ è®¾å¤‡: ${{ needs.prepare.outputs.target_device }}"
          echo "ğŸ“± å›ºä»¶: ${{ env.FIRMWARE_SIZE }}"
          echo "ğŸ”— ä¸‹è½½: https://github.com/${{ github.repository }}/releases/tag/${{ steps.release.outputs.release_tag }}"

      - name: ğŸ§¹ æ¸…ç†æ—§çš„å·¥ä½œæµç¨‹è®°å½•
        uses: GitRML/delete-workflow-runs@main
        with:
          retain_days: 7
          keep_minimum_runs: 5
          token: ${{ secrets.GITHUB_TOKEN }}