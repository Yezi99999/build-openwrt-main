#========================================================================================================================
# ğŸ› ï¸ OpenWrt æ™ºèƒ½ç¼–è¯‘å·¥ä½œæµ
# åŠŸèƒ½: æ¥æ”¶Webç•Œé¢ä¼ é€’çš„é…ç½®å‚æ•°ï¼Œæ™ºèƒ½ç¼–è¯‘æŒ‡å®šè®¾å¤‡å’Œæ’ä»¶çš„å›ºä»¶
#========================================================================================================================

name: ğŸ› ï¸ æ™ºèƒ½ç¼–è¯‘å›ºä»¶

on:
  # Webç•Œé¢è§¦å‘ï¼ˆæ¨èæ–¹å¼ï¼‰
  repository_dispatch:
    types: [web_build]
  
  # æ‰‹åŠ¨è§¦å‘ï¼ˆå¤‡ç”¨æ–¹å¼ï¼‰
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'æºç åˆ†æ”¯'
        required: true
        default: 'lede-master'
        type: choice
        options:
          - lede-master
          - openwrt-main
          - immortalwrt-master
          - Lienol-master
      target_device:
        description: 'ç›®æ ‡è®¾å¤‡'
        required: true
        default: 'x86_64'
        type: choice
        options:
          - x86_64
          - xiaomi_4a_gigabit
          - newifi_d2
          - rpi_4b
          - nanopi_r2s
          - k2p
          - ac68u
          - r7800
          - wrt3200acm
      plugins_list:
        description: 'æ’ä»¶åˆ—è¡¨ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰'
        required: false
        default: ''
        type: string
      build_description:
        description: 'ç¼–è¯‘æè¿°'
        required: false
        default: 'æ‰‹åŠ¨è§¦å‘ç¼–è¯‘'
        type: string

# ç¯å¢ƒå˜é‡
env:
  TZ: Asia/Shanghai
  UPLOAD_BIN_DIR: false
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  UPLOAD_WETRANSFER: false
  UPLOAD_ANON: false
  CACHE_TOOLCHAIN: true

jobs:
  # é¢„å¤„ç†ä»»åŠ¡
  prepare:
    runs-on: ubuntu-24.04
    name: ğŸ“‹ å‡†å¤‡ç¼–è¯‘ç¯å¢ƒ
    outputs:
      source_branch: ${{ steps.config.outputs.source_branch }}
      target_device: ${{ steps.config.outputs.target_device }}
      plugins_list: ${{ steps.config.outputs.plugins_list }}
      build_description: ${{ steps.config.outputs.build_description }}
      repo_url: ${{ steps.config.outputs.repo_url }}
      repo_branch: ${{ steps.config.outputs.repo_branch }}
      source_name: ${{ steps.config.outputs.source_name }}
      device_name: ${{ steps.config.outputs.device_name }}
      device_profile: ${{ steps.config.outputs.device_profile }}
      device_target: ${{ steps.config.outputs.device_target }}
      build_tag: ${{ steps.config.outputs.build_tag }}
      cache_key: ${{ steps.config.outputs.cache_key }}
      config_file: ${{ steps.config.outputs.config_file }}
      feeds_conf: ${{ steps.config.outputs.feeds_conf }}
      diy_p1_sh: ${{ steps.config.outputs.diy_p1_sh }}
      diy_p2_sh: ${{ steps.config.outputs.diy_p2_sh }}

    steps:
      - name: ğŸš€ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ è§£æç¼–è¯‘é…ç½®
        id: config
        run: |
          echo "ğŸ“‹ è§£æç¼–è¯‘é…ç½®..."
          
          # æ ¹æ®è§¦å‘æ–¹å¼è·å–é…ç½®å‚æ•°
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "ğŸŒ æ£€æµ‹åˆ°Webç•Œé¢è§¦å‘çš„ç¼–è¯‘è¯·æ±‚"
            SOURCE_BRANCH="${{ github.event.client_payload.source_branch }}"
            TARGET_DEVICE="${{ github.event.client_payload.target_device }}"
            PLUGINS_LIST="${{ github.event.client_payload.plugins }}"
            BUILD_DESC="Webç•Œé¢ç¼–è¯‘"
          else
            echo "ğŸ–±ï¸ æ£€æµ‹åˆ°æ‰‹åŠ¨è§¦å‘çš„ç¼–è¯‘è¯·æ±‚"
            SOURCE_BRANCH="${{ github.event.inputs.source_branch }}"
            TARGET_DEVICE="${{ github.event.inputs.target_device }}"
            PLUGINS_LIST="${{ github.event.inputs.plugins_list }}"
            BUILD_DESC="${{ github.event.inputs.build_description }}"
          fi
          
          # è®¾ç½®é»˜è®¤å€¼
          SOURCE_BRANCH=${SOURCE_BRANCH:-"lede-master"}
          TARGET_DEVICE=${TARGET_DEVICE:-"x86_64"}
          PLUGINS_LIST=${PLUGINS_LIST:-""}
          BUILD_DESC=${BUILD_DESC:-"æ™ºèƒ½ç¼–è¯‘"}
          
          echo "ğŸ“‹ ç¼–è¯‘é…ç½®ä¿¡æ¯:"
          echo "  æºç åˆ†æ”¯: $SOURCE_BRANCH"
          echo "  ç›®æ ‡è®¾å¤‡: $TARGET_DEVICE"
          echo "  æ’ä»¶åˆ—è¡¨: $PLUGINS_LIST"
          echo "  ç¼–è¯‘æè¿°: $BUILD_DESC"
          
          # æ ¹æ®æºç åˆ†æ”¯è®¾ç½®ä»“åº“ä¿¡æ¯å’Œé…ç½®æ–‡ä»¶è·¯å¾„
          case $SOURCE_BRANCH in
            "openwrt-main")
              REPO_URL="https://github.com/openwrt/openwrt"
              REPO_BRANCH="main"
              SOURCE_NAME="OpenWrtå®˜æ–¹"
              FEEDS_CONF="config/openwrt-main/feeds.conf.default"
              CONFIG_FILE="config/openwrt-main/config"
              DIY_P1_SH="config/openwrt-main/diy-part1.sh"
              DIY_P2_SH="config/openwrt-main/diy-part2.sh"
              ;;
            "lede-master")
              REPO_URL="https://github.com/coolsnowwolf/lede"
              REPO_BRANCH="master"
              SOURCE_NAME="Lean's LEDE"
              FEEDS_CONF="config/lede-master/feeds.conf.default"
              CONFIG_FILE="config/lede-master/config"
              DIY_P1_SH="config/lede-master/diy-part1.sh"
              DIY_P2_SH="config/lede-master/diy-part2.sh"
              ;;
            "immortalwrt-master")
              REPO_URL="https://github.com/immortalwrt/immortalwrt"
              REPO_BRANCH="master"
              SOURCE_NAME="ImmortalWrt"
              FEEDS_CONF="config/immortalwrt-master/feeds.conf.default"
              CONFIG_FILE="config/immortalwrt-master/config"
              DIY_P1_SH="config/immortalwrt-master/diy-part1.sh"
              DIY_P2_SH="config/immortalwrt-master/diy-part2.sh"
              ;;
            "Lienol-master")
              REPO_URL="https://github.com/Lienol/openwrt"
              REPO_BRANCH="master"
              SOURCE_NAME="Lienol's OpenWrt"
              FEEDS_CONF="config/Lienol-master/feeds.conf.default"
              CONFIG_FILE="config/Lienol-master/config"
              DIY_P1_SH="config/Lienol-master/diy-part1.sh"
              DIY_P2_SH="config/Lienol-master/diy-part2.sh"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„æºç åˆ†æ”¯: $SOURCE_BRANCH"
              exit 1
              ;;
          esac
          
          # æ ¹æ®ç›®æ ‡è®¾å¤‡è®¾ç½®è®¾å¤‡ä¿¡æ¯
          case $TARGET_DEVICE in
            "x86_64")
              DEVICE_NAME="X86_64è™šæ‹Ÿæœº"
              DEVICE_PROFILE="generic"
              DEVICE_TARGET="x86/64"
              CONFIG_FILE="${CONFIG_FILE}_x86_64"
              ;;
            "xiaomi_4a_gigabit")
              DEVICE_NAME="å°ç±³è·¯ç”±å™¨4Aåƒå…†ç‰ˆ"
              DEVICE_PROFILE="xiaomi_mi-router-4a-gigabit"
              DEVICE_TARGET="ramips/mt7621"
              CONFIG_FILE="${CONFIG_FILE}_mi4a"
              ;;
            "newifi_d2")
              DEVICE_NAME="æ–°è·¯ç”±3"
              DEVICE_PROFILE="d-team_newifi-d2"
              DEVICE_TARGET="ramips/mt7621"
              CONFIG_FILE="${CONFIG_FILE}_d2"
              ;;
            "rpi_4b")
              DEVICE_NAME="æ ‘è“æ´¾4B"
              DEVICE_PROFILE="rpi-4"
              DEVICE_TARGET="bcm27xx/bcm2711"
              CONFIG_FILE="${CONFIG_FILE}_rpi4"
              ;;
            "nanopi_r2s")
              DEVICE_NAME="NanoPi R2S"
              DEVICE_PROFILE="friendlyarm_nanopi-r2s"
              DEVICE_TARGET="rockchip/armv8"
              CONFIG_FILE="${CONFIG_FILE}_r2s"
              ;;
            "k2p")
              DEVICE_NAME="æ–è®¯K2P"
              DEVICE_PROFILE="phicomm_k2p"
              DEVICE_TARGET="ramips/mt7621"
              CONFIG_FILE="${CONFIG_FILE}_k2p"
              ;;
            "ac68u")
              DEVICE_NAME="åç¡•AC68U"
              DEVICE_PROFILE="asus_rt-ac68u"
              DEVICE_TARGET="bcm53xx/generic"
              CONFIG_FILE="${CONFIG_FILE}_ac68u"
              ;;
            "r7800")
              DEVICE_NAME="ç½‘ä»¶R7800"
              DEVICE_PROFILE="netgear_r7800"
              DEVICE_TARGET="ipq806x/generic"
              CONFIG_FILE="${CONFIG_FILE}_r7800"
              ;;
            "wrt3200acm")
              DEVICE_NAME="é¢†åŠ¿WRT3200ACM"
              DEVICE_PROFILE="linksys_wrt3200acm"
              DEVICE_TARGET="mvebu/cortexa9"
              CONFIG_FILE="${CONFIG_FILE}_wrt3200acm"
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„ç›®æ ‡è®¾å¤‡: $TARGET_DEVICE"
              exit 1
              ;;
          esac
          
          # ç”Ÿæˆç¼–è¯‘æ ‡ç­¾
          BUILD_TAG="${SOURCE_BRANCH}_${TARGET_DEVICE}_$(date +%Y%m%d_%H%M%S)"
          CACHE_KEY="${SOURCE_BRANCH}_${TARGET_DEVICE}_cache"
          
          # è¾“å‡ºé…ç½®ä¿¡æ¯
          echo "source_branch=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
          echo "target_device=$TARGET_DEVICE" >> $GITHUB_OUTPUT
          echo "plugins_list=$PLUGINS_LIST" >> $GITHUB_OUTPUT
          echo "build_description=$BUILD_DESC" >> $GITHUB_OUTPUT
          echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT
          echo "repo_branch=$REPO_BRANCH" >> $GITHUB_OUTPUT
          echo "source_name=$SOURCE_NAME" >> $GITHUB_OUTPUT
          echo "device_name=$DEVICE_NAME" >> $GITHUB_OUTPUT
          echo "device_profile=$DEVICE_PROFILE" >> $GITHUB_OUTPUT
          echo "device_target=$DEVICE_TARGET" >> $GITHUB_OUTPUT
          echo "build_tag=$BUILD_TAG" >> $GITHUB_OUTPUT
          echo "cache_key=$CACHE_KEY" >> $GITHUB_OUTPUT
          echo "config_file=$CONFIG_FILE" >> $GITHUB_OUTPUT
          echo "feeds_conf=$FEEDS_CONF" >> $GITHUB_OUTPUT
          echo "diy_p1_sh=$DIY_P1_SH" >> $GITHUB_OUTPUT
          echo "diy_p2_sh=$DIY_P2_SH" >> $GITHUB_OUTPUT

      - name: ğŸ” æ£€æµ‹æ’ä»¶å†²çª
        if: needs.prepare.outputs.plugins_list != ''
        run: |
          echo "ğŸ” æ£€æµ‹æ’ä»¶å†²çª..."
          PLUGINS="${{ needs.prepare.outputs.plugins_list }}"
          
          # å®šä¹‰æ’ä»¶å†²çªè§„åˆ™
          declare -A conflicts=(
            ["luci-app-ssr-plus,luci-app-passwall"]="SSR Plus+å’ŒPassWallåŠŸèƒ½é‡å¤"
            ["luci-app-ssr-plus,luci-app-openclash"]="SSR Plus+å’ŒOpenClashå¯èƒ½å†²çª"
            ["luci-app-passwall,luci-app-openclash"]="PassWallå’ŒOpenClashå¯èƒ½å†²çª"
            ["luci-app-adguardhome,luci-app-adblock"]="AdGuard Homeå’ŒAdBlockåŠŸèƒ½é‡å¤"
            ["luci-app-unblockmusic,luci-app-unblockneteasemusic"]="è§£é”ç½‘æ˜“äº‘éŸ³ä¹æ’ä»¶é‡å¤"
          )
          
          # æ£€æŸ¥å†²çª
          HAS_CONFLICT=false
          for conflict_pair in "${!conflicts[@]}"; do
            IFS=',' read -ra conflict_plugins <<< "$conflict_pair"
            FOUND_COUNT=0
            
            for plugin in "${conflict_plugins[@]}"; do
              if [[ ",$PLUGINS," == *",$plugin,"* ]]; then
                ((FOUND_COUNT++))
              fi
            done
            
            if [ $FOUND_COUNT -gt 1 ]; then
              echo "âš ï¸ æ£€æµ‹åˆ°æ’ä»¶å†²çª: ${conflicts[$conflict_pair]}"
              HAS_CONFLICT=true
            fi
          done
          
          if [ "$HAS_CONFLICT" = true ]; then
            echo "âš ï¸ æ£€æµ‹åˆ°æ’ä»¶å†²çªï¼Œç¼–è¯‘å¯èƒ½å¤±è´¥ï¼Œå»ºè®®è°ƒæ•´æ’ä»¶é€‰æ‹©"
          else
            echo "âœ… æ’ä»¶å†²çªæ£€æµ‹é€šè¿‡"
          fi

      - name: ğŸ“Š ç”Ÿæˆç¼–è¯‘æŠ¥å‘Š
        run: |
          echo "# ğŸ“Š OpenWrtæ™ºèƒ½ç¼–è¯‘æŠ¥å‘Š" > build_report.md
          echo "" >> build_report.md
          echo "## ğŸ“‹ ç¼–è¯‘é…ç½®" >> build_report.md
          echo "- **æºç **: ${{ needs.prepare.outputs.source_name }} (${{ needs.prepare.outputs.source_branch }})" >> build_report.md
          echo "- **è®¾å¤‡**: ${{ needs.prepare.outputs.device_name }} (${{ needs.prepare.outputs.target_device }})" >> build_report.md
          echo "- **æ¶æ„**: ${{ needs.prepare.outputs.device_target }}" >> build_report.md
          echo "- **æè¿°**: ${{ needs.prepare.outputs.build_description }}" >> build_report.md
          echo "- **æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> build_report.md
          echo "" >> build_report.md
          
          if [ -n "${{ needs.prepare.outputs.plugins_list }}" ]; then
            echo "## ğŸ”§ é€‰ä¸­çš„æ’ä»¶" >> build_report.md
            IFS=',' read -ra PLUGINS <<< "${{ needs.prepare.outputs.plugins_list }}"
            for plugin in "${PLUGINS[@]}"; do
              echo "- $plugin" >> build_report.md
            done
          else
            echo "## ğŸ”§ æ’ä»¶" >> build_report.md
            echo "ä½¿ç”¨é»˜è®¤æ’ä»¶é…ç½®" >> build_report.md
          fi

  # ä¸»ç¼–è¯‘ä»»åŠ¡
  build:
    runs-on: ubuntu-24.04
    needs: prepare
    name: ğŸ› ï¸ ç¼–è¯‘ ${{ needs.prepare.outputs.device_name }}
    
    steps:
      - name: ğŸš€ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ’¾ æ¢å¤ç¼“å­˜
        if: env.CACHE_TOOLCHAIN == 'true'
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/host*
            openwrt/staging_dir/tool*
            openwrt/build_dir/host*
            openwrt/build_dir/tool*
          key: ${{ needs.prepare.outputs.cache_key }}_${{ hashFiles('**/feeds.conf.default') }}
          restore-keys: |
            ${{ needs.prepare.outputs.cache_key }}_

      - name: ğŸ”§ åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
        id: init
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          echo "ğŸ”§ å¼€å§‹åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ..."
          
          # é‡Šæ”¾ç£ç›˜ç©ºé—´
          echo "ğŸ’¾ é‡Šæ”¾ç£ç›˜ç©ºé—´..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/.ghcup
          sudo rm -rf /usr/share/swift
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          
          # æ›´æ–°ç³»ç»ŸåŒ…
          echo "ğŸ“¦ æ›´æ–°ç³»ç»ŸåŒ…..."
          sudo -E apt-get -qq update
          
          # å®‰è£…ç¼–è¯‘ä¾èµ–
          echo "ğŸ“¦ å®‰è£…ç¼–è¯‘ä¾èµ–..."
          sudo -E apt-get -qq install -y \
            ack antlr3 asciidoc autoconf automake autopoint binutils bison build-essential \
            bzip2 ccache clang cmake cpio curl device-tree-compiler ecj fastjar flex gawk \
            gettext gcc-multilib g++-multilib git gnutls-dev gperf haveged help2man intltool \
            lib32gcc-s1 libc6-dev-i386 libelf-dev libglib2.0-dev libgmp3-dev libltdl-dev \
            libmpc-dev libmpfr-dev libncurses5-dev libncursesw5 libncursesw5-dev libpython3-dev \
            libreadline-dev libssl-dev libtool lld llvm lrzsz mkisofs msmtp nano ninja-build \
            p7zip p7zip-full patch pkgconf python2.7 python3 python3-pip python3-ply \
            python3-docutils python3-pyelftools qemu-utils re2c rsync scons squashfs-tools \
            subversion swig texinfo uglifyjs upx-ucl unzip vim wget xmlto xxd zlib1g-dev
          
          # æ¸…ç†ä¸éœ€è¦çš„åŒ…
          echo "ğŸ§¹ æ¸…ç†ç³»ç»Ÿ..."
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq autoclean
          sudo -E apt-get -qq clean
          
          # åˆ›å»ºå·¥ä½œç›®å½•
          echo "ğŸ“ åˆ›å»ºå·¥ä½œç›®å½•..."
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir
          
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… ç¼–è¯‘ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

      - name: ğŸ“¦ å…‹éš†æºç 
        id: codes
        working-directory: /workdir
        if: steps.init.outputs.status == 'success' && !cancelled()
        run: |
          echo "ğŸ“¦ å¼€å§‹å…‹éš†æºç ..."
          echo "  ä»“åº“: ${{ needs.prepare.outputs.repo_url }}"
          echo "  åˆ†æ”¯: ${{ needs.prepare.outputs.repo_branch }}"
          
          # å…‹éš†æºç 
          git clone -q --single-branch --depth=1 --branch=${{ needs.prepare.outputs.repo_branch }} ${{ needs.prepare.outputs.repo_url }} openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt
          
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… æºç å…‹éš†å®Œæˆ"

      - name: ğŸ”§ åŠ è½½è‡ªå®šä¹‰feeds
        run: |
          echo "ğŸ”§ é…ç½®è‡ªå®šä¹‰feeds..."
          
          # å¦‚æœå­˜åœ¨è‡ªå®šä¹‰feedsé…ç½®
          if [ -f "${{ needs.prepare.outputs.feeds_conf }}" ]; then
            cp -f ${{ needs.prepare.outputs.feeds_conf }} openwrt/feeds.conf.default
            echo "âœ… å·²åŠ è½½è‡ªå®šä¹‰feedsé…ç½®"
          fi
          
          # æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬1
          if [ -f "${{ needs.prepare.outputs.diy_p1_sh }}" ]; then
            chmod +x ${{ needs.prepare.outputs.diy_p1_sh }}
            cd openwrt
            $GITHUB_WORKSPACE/${{ needs.prepare.outputs.diy_p1_sh }}
            cd ..
            echo "âœ… å·²æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬1"
          fi

      - name: ğŸ“¥ æ›´æ–°feeds
        run: |
          cd openwrt
          echo "ğŸ“¥ æ›´æ–°feeds..."
          ./scripts/feeds update -a
          echo "âœ… Feedsæ›´æ–°å®Œæˆ"

      - name: ğŸ“¦ å®‰è£…feeds
        run: |
          cd openwrt
          echo "ğŸ“¦ å®‰è£…feeds..."
          ./scripts/feeds install -a
          echo "âœ… Feedså®‰è£…å®Œæˆ"

      - name: ğŸ”§ åŠ è½½è‡ªå®šä¹‰é…ç½®
        run: |
          echo "ğŸ”§ åŠ è½½è‡ªå®šä¹‰é…ç½®..."
          
          # åŠ è½½åŸºç¡€é…ç½®æ–‡ä»¶
          if [ -f "${{ needs.prepare.outputs.config_file }}" ]; then
            cp -f ${{ needs.prepare.outputs.config_file }} openwrt/.config
            echo "âœ… å·²åŠ è½½è®¾å¤‡åŸºç¡€é…ç½®"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°è®¾å¤‡é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
            cd openwrt
            make defconfig
            cd ..
          fi
          
          # æ ¹æ®é€‰æ‹©çš„æ’ä»¶åŠ¨æ€ä¿®æ”¹é…ç½®
          if [ -n "${{ needs.prepare.outputs.plugins_list }}" ]; then
            echo "ğŸ”§ é…ç½®é€‰ä¸­çš„æ’ä»¶..."
            cd openwrt
            
            # å…ˆç¦ç”¨æ‰€æœ‰å¯é€‰æ’ä»¶
            sed -i 's/CONFIG_PACKAGE_luci-app-.*=y/# CONFIG_PACKAGE_luci-app-.*=y/g' .config
            
            # å¯ç”¨é€‰ä¸­çš„æ’ä»¶
            IFS=',' read -ra PLUGINS <<< "${{ needs.prepare.outputs.plugins_list }}"
            for plugin in "${PLUGINS[@]}"; do
              echo "  å¯ç”¨æ’ä»¶: $plugin"
              echo "CONFIG_PACKAGE_$plugin=y" >> .config
              
              # å¤„ç†æ’ä»¶ä¾èµ–
              case $plugin in
                "luci-app-ssr-plus")
                  echo "CONFIG_PACKAGE_shadowsocksr-libev-ssr-check=y" >> .config
                  echo "CONFIG_PACKAGE_shadowsocksr-libev-ssr-local=y" >> .config
                  echo "CONFIG_PACKAGE_shadowsocksr-libev-ssr-redir=y" >> .config
                  ;;
                "luci-app-passwall")
                  echo "CONFIG_PACKAGE_chinadns-ng=y" >> .config
                  echo "CONFIG_PACKAGE_haproxy=y" >> .config
                  echo "CONFIG_PACKAGE_hysteria=y" >> .config
                  ;;
                "luci-app-openclash")
                  echo "CONFIG_PACKAGE_kmod-tun=y" >> .config
                  ;;
                "luci-app-dockerman")
                  echo "CONFIG_PACKAGE_docker-ce=y" >> .config
                  echo "CONFIG_PACKAGE_docker-compose=y" >> .config
                  echo "CONFIG_PACKAGE_dockerd=y" >> .config
                  ;;
              esac
            done
            
            cd ..
          fi
          
          # æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬2
          if [ -f "${{ needs.prepare.outputs.diy_p2_sh }}" ]; then
            chmod +x ${{ needs.prepare.outputs.diy_p2_sh }}
            cd openwrt
            $GITHUB_WORKSPACE/${{ needs.prepare.outputs.diy_p2_sh }}
            cd ..
            echo "âœ… å·²æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬2"
          fi

      - name: ğŸ“¥ ä¸‹è½½ç¼–è¯‘åŒ…
        id: package
        run: |
          cd openwrt
          echo "ğŸ“¥ ä¸‹è½½ç¼–è¯‘æ‰€éœ€çš„åŒ…..."
          make defconfig
          make download -j8
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
          echo "âœ… åŒ…ä¸‹è½½å®Œæˆ"

      - name: ğŸ› ï¸ å¼€å§‹ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd openwrt
          echo "ğŸ› ï¸ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
          echo "  è®¾å¤‡: ${{ needs.prepare.outputs.device_name }}"
          echo "  æ¶æ„: ${{ needs.prepare.outputs.device_target }}"
          echo -e "$(nproc) ä¸ªçº¿ç¨‹ç¼–è¯‘"
          
          # å¼€å§‹ç¼–è¯‘
          make -j$(nproc) || make -j1 || make -j1 V=s
          
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… å›ºä»¶ç¼–è¯‘å®Œæˆ"

      - name: ğŸ“Š æ£€æŸ¥ç£ç›˜ä½¿ç”¨
        if: (!cancelled())
        run: |
          echo "ğŸ“Š ç¼–è¯‘åç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -hT

      - name: ğŸ“¦ æ•´ç†å›ºä»¶æ–‡ä»¶
        id: organize
        if: steps.compile.outputs.status == 'success' && !cancelled()
        run: |
          echo "ğŸ“¦ æ•´ç†å›ºä»¶æ–‡ä»¶..."
          cd openwrt/bin/targets/*/*
          
          # åˆ é™¤ä¸éœ€è¦çš„æ–‡ä»¶
          rm -rf packages
          rm -f *.buildinfo
          rm -f *.manifest
          rm -f *.seed
          rm -f sha256sums
          
          # é‡å‘½åå›ºä»¶æ–‡ä»¶
          for file in openwrt-*; do
            if [ -f "$file" ]; then
              new_name="${{ needs.prepare.outputs.build_tag }}_${file#openwrt-}"
              mv "$file" "$new_name"
              echo "  $file -> $new_name"
            fi
          done
          
          # è®¡ç®—å›ºä»¶å¤§å°
          FIRMWARE_SIZE=$(ls -lh *.img.gz 2>/dev/null | awk '{print $5}' | head -1)
          if [ -z "$FIRMWARE_SIZE" ]; then
            FIRMWARE_SIZE=$(ls -lh *.bin 2>/dev/null | awk '{print $5}' | head -1)
          fi
          
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "FIRMWARE_SIZE=$FIRMWARE_SIZE" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… å›ºä»¶æ•´ç†å®Œæˆï¼Œå¤§å°: $FIRMWARE_SIZE"

      - name: ğŸ“¤ ä¸Šä¼ å›ºä»¶åˆ°Artifacts
        uses: actions/upload-artifact@v4
        if: steps.organize.outputs.status == 'success' && env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        with:
          name: OpenWrt_firmware_${{ needs.prepare.outputs.build_tag }}
          path: ${{ env.FIRMWARE }}

      - name: ğŸ·ï¸ ç”Ÿæˆå‘å¸ƒæ ‡ç­¾
        id: tag
        if: env.UPLOAD_RELEASE == 'true' && steps.organize.outputs.status == 'success' && !cancelled()
        run: |
          echo "release_tag=${{ needs.prepare.outputs.build_tag }}" >> $GITHUB_OUTPUT
          echo "âœ… å‘å¸ƒæ ‡ç­¾: ${{ needs.prepare.outputs.build_tag }}"

      - name: ğŸ“‹ ç”Ÿæˆå‘å¸ƒè¯´æ˜
        if: env.UPLOAD_RELEASE == 'true' && steps.organize.outputs.status == 'success' && !cancelled()
        run: |
          echo "# ğŸ› ï¸ OpenWrtæ™ºèƒ½ç¼–è¯‘å›ºä»¶" > release.md
          echo "" >> release.md
          echo "## ğŸ“‹ å›ºä»¶ä¿¡æ¯" >> release.md
          echo "- **æºç **: ${{ needs.prepare.outputs.source_name }} (${{ needs.prepare.outputs.source_branch }})" >> release.md
          echo "- **è®¾å¤‡**: ${{ needs.prepare.outputs.device_name }} (${{ needs.prepare.outputs.target_device }})" >> release.md
          echo "- **æ¶æ„**: ${{ needs.prepare.outputs.device_target }}" >> release.md
          echo "- **å¤§å°**: ${{ env.FIRMWARE_SIZE }}" >> release.md
          echo "- **ç¼–è¯‘æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')" >> release.md
          echo "- **ç¼–è¯‘æè¿°**: ${{ needs.prepare.outputs.build_description }}" >> release.md
          echo "" >> release.md
          
          if [ -n "${{ needs.prepare.outputs.plugins_list }}" ]; then
            echo "## ğŸ”§ åŒ…å«çš„æ’ä»¶" >> release.md
            IFS=',' read -ra PLUGINS <<< "${{ needs.prepare.outputs.plugins_list }}"
            for plugin in "${PLUGINS[@]}"; do
              echo "- âœ… $plugin" >> release.md
            done
          else
            echo "## ğŸ”§ æ’ä»¶" >> release.md
            echo "ä½¿ç”¨æºç é»˜è®¤æ’ä»¶é…ç½®" >> release.md
          fi
          
          echo "" >> release.md
          echo "## ğŸ“¥ ä¸‹è½½è¯´æ˜" >> release.md
          echo "1. æ ¹æ®è®¾å¤‡å‹å·é€‰æ‹©å¯¹åº”çš„å›ºä»¶æ–‡ä»¶" >> release.md
          echo "2. åˆ·å†™å‰è¯·å¤‡ä»½åŸæœ‰é…ç½®" >> release.md
          echo "3. é¦–æ¬¡åˆ·å…¥å»ºè®®ä¸ä¿ç•™é…ç½®" >> release.md
          echo "" >> release.md
          echo "## âš ï¸ æ³¨æ„äº‹é¡¹" >> release.md
          echo "- åˆ·æœºæœ‰é£é™©ï¼Œè¯·è°¨æ…æ“ä½œ" >> release.md
          echo "- ç¡®ä¿è®¾å¤‡å‹å·åŒ¹é…" >> release.md
          echo "- å»ºè®®å…ˆåœ¨æ¢å¤æ¨¡å¼ä¸‹åˆ·å…¥" >> release.md

      - name: ğŸ“¤ ä¸Šä¼ å›ºä»¶åˆ°Release
        uses: softprops/action-gh-release@v2
        if: env.UPLOAD_RELEASE == 'true' && steps.organize.outputs.status == 'success' && !cancelled()
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.md
          files: ${{ env.FIRMWARE }}/*

      - name: ğŸ“Š ç”Ÿæˆç¼–è¯‘æ€»ç»“
        if: steps.organize.outputs.status == 'success' && !cancelled()
        run: |
          echo "ğŸ‰ ç¼–è¯‘æˆåŠŸå®Œæˆï¼"
          echo ""
          echo "ğŸ“¦ å›ºä»¶ä¿¡æ¯:"
          echo "  æºç : ${{ needs.prepare.outputs.source_name }}"
          echo "  è®¾å¤‡: ${{ needs.prepare.outputs.device_name }}"
          echo "  å¤§å°: ${{ env.FIRMWARE_SIZE }}"
          echo "  æ ‡ç­¾: ${{ needs.prepare.outputs.build_tag }}"
          echo ""
          echo "ğŸ”— ä¸‹è½½é“¾æ¥:"
          echo "  Artifacts: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "  Releases: https://github.com/${{ github.repository }}/releases/tag/${{ steps.tag.outputs.release_tag }}"

      - name: ğŸ§¹ æ¸…ç†å·¥ä½œç©ºé—´
        if: always()
        run: |
          cd /workdir
          rm -rf openwrt
          echo "âœ… å·¥ä½œç©ºé—´æ¸…ç†å®Œæˆ"