#========================================================================================================================
# OpenWrt æ™ºèƒ½ç¼–è¯‘å·¥ä½œæµ v2.0 - è§£è€¦æ¶æ„è®¾è®¡
# ç‰¹ç‚¹: ç»Ÿä¸€å…¥å£ç‚¹ | é…ç½®é©±åŠ¨ | è‡ªåŠ¨ä¿®å¤ | æ¨¡å—åŒ–è®¾è®¡
# æ¶æ„ä¼˜åŠ¿: é¿å…"ç‰µä¸€å‘è€ŒåŠ¨å…¨èº«"ï¼Œæé«˜å¯ç»´æŠ¤æ€§å’Œç¨³å®šæ€§
#========================================================================================================================

name: ğŸ­ æ™ºèƒ½ç¼–è¯‘å·¥ä½œæµ v2.0

# è§¦å‘æ¡ä»¶ - æ”¯æŒå¤šç§è§¦å‘æ–¹å¼
on:
  # ä»“åº“åˆ†å‘äº‹ä»¶ (ä¸»è¦è§¦å‘æ–¹å¼)
  repository_dispatch:
    types: [web_build, api_build, manual_build]
  
  # å·¥ä½œæµåˆ†å‘ (GitHubç•Œé¢æ‰‹åŠ¨è§¦å‘)
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'æºç åˆ†æ”¯'
        required: true
        default: 'lede-master'
        type: choice
        options:
          - 'lede-master'
          - 'openwrt-main'
          - 'immortalwrt-master'
          - 'Lienol-master'
      target_device:
        description: 'ç›®æ ‡è®¾å¤‡'
        required: true
        default: 'x86_64'
        type: choice
        options:
          - 'x86_64'
          - 'xiaomi_4a_gigabit'
          - 'newifi_d2'
          - 'rpi_4b'
          - 'nanopi_r2s'
      plugins:
        description: 'æ’ä»¶åˆ—è¡¨ (é€—å·åˆ†éš”)'
        required: false
        default: ''
        type: string
      enable_auto_fix:
        description: 'å¯ç”¨è‡ªåŠ¨ä¿®å¤'
        required: false
        default: true
        type: boolean
      description:
        description: 'ç¼–è¯‘æè¿°'
        required: false
        default: 'æ‰‹åŠ¨è§¦å‘ç¼–è¯‘'
        type: string

# ç¯å¢ƒå˜é‡ - å…¨å±€é…ç½®
env:
  # æ„å»ºé…ç½®
  DEBIAN_FRONTEND: noninteractive
  TZ: Asia/Shanghai
  
  # GitHub Actionsé…ç½®
  ACTIONS_ALLOW_UNSECURE_COMMANDS: true
  FORCE_COLOR: 1
  
  # æ„å»ºç¼–æ’å™¨é…ç½®
  ORCHESTRATOR_VERSION: '1.0.0'
  AUTO_FIX_ENABLED: true
  VERBOSE_MODE: true

# æƒé™è®¾ç½®
permissions:
  contents: read
  actions: read
  packages: read

# å¹¶å‘æ§åˆ¶ - é¿å…èµ„æºå†²çª
concurrency:
  group: build-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

#========================================================================================================================
# ä½œä¸šå®šä¹‰
#========================================================================================================================

jobs:
  # é…ç½®è§£æå’ŒéªŒè¯ä½œä¸š
  config-analysis:
    name: ğŸ“‹ é…ç½®è§£æä¸éªŒè¯
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    outputs:
      # æ„å»ºå‚æ•°
      build_id: ${{ steps.parse.outputs.build_id }}
      source_branch: ${{ steps.parse.outputs.source_branch }}
      target_device: ${{ steps.parse.outputs.target_device }}
      plugins_list: ${{ steps.parse.outputs.plugins_list }}
      auto_fix_enabled: ${{ steps.parse.outputs.auto_fix_enabled }}
      build_description: ${{ steps.parse.outputs.build_description }}
      
      # éªŒè¯ç»“æœ
      config_valid: ${{ steps.validate.outputs.config_valid }}
      device_supported: ${{ steps.validate.outputs.device_supported }}
      
      # ç¼“å­˜é…ç½®
      cache_key: ${{ steps.cache.outputs.cache_key }}
      
    steps:
      - name: ğŸš€ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: ğŸ“Š è§£ææ„å»ºå‚æ•°
        id: parse
        run: |
          echo "ğŸ” è§£ææ„å»ºå‚æ•°..."
          
          # ç”Ÿæˆå”¯ä¸€æ„å»ºID
          BUILD_ID="build_$(date +%s)_${GITHUB_RUN_NUMBER}"
          echo "build_id=$BUILD_ID" >> $GITHUB_OUTPUT
          
          # è§£æè§¦å‘æ¥æºå’Œå‚æ•°
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            # Repository Dispatch è§¦å‘ (API/Webç•Œé¢)
            SOURCE_BRANCH="${{ github.event.client_payload.source_branch || 'lede-master' }}"
            TARGET_DEVICE="${{ github.event.client_payload.target_device || 'x86_64' }}"
            PLUGINS_LIST="${{ github.event.client_payload.plugins || '' }}"
            AUTO_FIX="${{ github.event.client_payload.enable_auto_fix || 'true' }}"
            DESCRIPTION="${{ github.event.client_payload.description || 'APIè§¦å‘ç¼–è¯‘' }}"
            
            echo "ğŸ“¡ è§¦å‘æ–¹å¼: Repository Dispatch (${{ github.event.action }})"
          else
            # Workflow Dispatch è§¦å‘ (GitHubç•Œé¢)
            SOURCE_BRANCH="${{ github.event.inputs.source_branch }}"
            TARGET_DEVICE="${{ github.event.inputs.target_device }}"
            PLUGINS_LIST="${{ github.event.inputs.plugins }}"
            AUTO_FIX="${{ github.event.inputs.enable_auto_fix }}"
            DESCRIPTION="${{ github.event.inputs.description }}"
            
            echo "ğŸ–±ï¸ è§¦å‘æ–¹å¼: Workflow Dispatch (æ‰‹åŠ¨è§¦å‘)"
          fi
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "source_branch=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
          echo "target_device=$TARGET_DEVICE" >> $GITHUB_OUTPUT
          echo "plugins_list=$PLUGINS_LIST" >> $GITHUB_OUTPUT
          echo "auto_fix_enabled=$AUTO_FIX" >> $GITHUB_OUTPUT
          echo "build_description=$DESCRIPTION" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºè§£æç»“æœ
          echo "ğŸ“‹ æ„å»ºé…ç½®:"
          echo "  æ„å»ºID: $BUILD_ID"
          echo "  æºç åˆ†æ”¯: $SOURCE_BRANCH"
          echo "  ç›®æ ‡è®¾å¤‡: $TARGET_DEVICE"
          echo "  æ’ä»¶åˆ—è¡¨: ${PLUGINS_LIST:-æ— }"
          echo "  è‡ªåŠ¨ä¿®å¤: $AUTO_FIX"
          echo "  ç¼–è¯‘æè¿°: $DESCRIPTION"
      
      - name: âœ… éªŒè¯æ„å»ºé…ç½®
        id: validate
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºé…ç½®..."
          
          # æ”¯æŒçš„è®¾å¤‡åˆ—è¡¨
          SUPPORTED_DEVICES=("x86_64" "xiaomi_4a_gigabit" "newifi_d2" "rpi_4b" "nanopi_r2s")
          SUPPORTED_SOURCES=("lede-master" "openwrt-main" "immortalwrt-master" "Lienol-master")
          
          # éªŒè¯è®¾å¤‡æ”¯æŒ
          DEVICE_SUPPORTED=false
          for device in "${SUPPORTED_DEVICES[@]}"; do
            if [ "$device" = "${{ steps.parse.outputs.target_device }}" ]; then
              DEVICE_SUPPORTED=true
              break
            fi
          done
          
          # éªŒè¯æºç åˆ†æ”¯
          SOURCE_SUPPORTED=false
          for source in "${SUPPORTED_SOURCES[@]}"; do
            if [ "$source" = "${{ steps.parse.outputs.source_branch }}" ]; then
              SOURCE_SUPPORTED=true
              break
            fi
          done
          
          # éªŒè¯æ’ä»¶æ ¼å¼ (åŸºæœ¬æ£€æŸ¥)
          PLUGINS_VALID=true
          PLUGINS="${{ steps.parse.outputs.plugins_list }}"
          if [ -n "$PLUGINS" ]; then
            # æ£€æŸ¥æ˜¯å¦åŒ…å«æ˜æ˜¾çš„æ— æ•ˆå­—ç¬¦
            if [[ "$PLUGINS" =~ [^a-zA-Z0-9,._-] ]]; then
              echo "âš ï¸ æ’ä»¶åˆ—è¡¨åŒ…å«å¯èƒ½æ— æ•ˆçš„å­—ç¬¦: $PLUGINS"
              PLUGINS_VALID=false
            fi
          fi
          
          # æ€»ä½“é…ç½®æœ‰æ•ˆæ€§
          CONFIG_VALID=true
          if [ "$DEVICE_SUPPORTED" != "true" ]; then
            echo "âŒ ä¸æ”¯æŒçš„è®¾å¤‡: ${{ steps.parse.outputs.target_device }}"
            CONFIG_VALID=false
          fi
          
          if [ "$SOURCE_SUPPORTED" != "true" ]; then
            echo "âŒ ä¸æ”¯æŒçš„æºç åˆ†æ”¯: ${{ steps.parse.outputs.source_branch }}"
            CONFIG_VALID=false
          fi
          
          if [ "$PLUGINS_VALID" != "true" ]; then
            echo "âŒ æ’ä»¶åˆ—è¡¨æ ¼å¼æ— æ•ˆ"
            CONFIG_VALID=false
          fi
          
          # è®¾ç½®è¾“å‡º
          echo "config_valid=$CONFIG_VALID" >> $GITHUB_OUTPUT
          echo "device_supported=$DEVICE_SUPPORTED" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºéªŒè¯ç»“æœ
          if [ "$CONFIG_VALID" = "true" ]; then
            echo "âœ… é…ç½®éªŒè¯é€šè¿‡"
          else
            echo "âŒ é…ç½®éªŒè¯å¤±è´¥"
            exit 1
          fi
      

  # æ„å»ºå‡†å¤‡ä½œä¸š
  build-preparation:
    name: ğŸ› ï¸ æ„å»ºå‡†å¤‡ä¸é…ç½®ç”Ÿæˆ
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    needs: config-analysis
    if: needs.config-analysis.outputs.config_valid == 'true'
    outputs:
      config_generated: ${{ steps.orchestrator.outputs.config_generated }}
      build_ready: ${{ steps.orchestrator.outputs.build_ready }}
    
    steps:
      - name: ğŸš€ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
        run: |
          echo "ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–..."
          sudo apt-get update -qq
          sudo apt-get install -y jq curl wget git
          
          echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"
      
      - name: ğŸ­ åˆå§‹åŒ–æ„å»ºç¼–æ’å™¨
        run: |
          echo "ğŸ­ åˆå§‹åŒ–æ„å»ºç¼–æ’å™¨..."
          
          # ç¡®ä¿ç¼–æ’å™¨è„šæœ¬å­˜åœ¨ä¸”æœ‰æ‰§è¡Œæƒé™
          if [ ! -f "script/build-orchestrator.sh" ]; then
            echo "âŒ æ„å»ºç¼–æ’å™¨è„šæœ¬ä¸å­˜åœ¨"
            echo "ğŸ”„ å°è¯•ä½¿ç”¨ä¼ ç»Ÿæ–¹å¼..."
            
            # å›é€€åˆ°ä¼ ç»Ÿè„šæœ¬ç»„åˆ
            chmod +x script/generate-config.sh 2>/dev/null || true
            chmod +x script/plugin-manager.sh 2>/dev/null || true
            exit 0
          fi
          
          chmod +x script/build-orchestrator.sh
          
          # åˆå§‹åŒ–é…ç½®ç³»ç»Ÿ
          ./script/build-orchestrator.sh config init
          
          echo "âœ… æ„å»ºç¼–æ’å™¨åˆå§‹åŒ–å®Œæˆ"
      
      - name: ğŸ”§ æ‰§è¡Œæ„å»ºç¼–æ’
        id: orchestrator
        run: |
          echo "ğŸ”§ æ‰§è¡Œæ„å»ºç¼–æ’..."
          
          # æ„å»ºå‚æ•°
          DEVICE="${{ needs.config-analysis.outputs.target_device }}"
          PLUGINS="${{ needs.config-analysis.outputs.plugins_list }}"
          SOURCE="${{ needs.config-analysis.outputs.source_branch }}"
          AUTO_FIX="${{ needs.config-analysis.outputs.auto_fix_enabled }}"
          
          # æ‰§è¡Œç¼–æ’å™¨
          ORCHESTRATOR_ARGS=(
            "build"
            "--device" "$DEVICE"
            "--source" "$SOURCE"
            "--verbose"
          )
          
          # æ·»åŠ æ’ä»¶å‚æ•°
          if [ -n "$PLUGINS" ]; then
            ORCHESTRATOR_ARGS+=("--plugins" "$PLUGINS")
          fi
          
          # æ·»åŠ è‡ªåŠ¨ä¿®å¤å‚æ•°
          if [ "$AUTO_FIX" = "true" ]; then
            ORCHESTRATOR_ARGS+=("--auto-fix")
          else
            ORCHESTRATOR_ARGS+=("--no-auto-fix")
          fi
          
          echo "ğŸš€ æ‰§è¡Œ: ./script/build-orchestrator.sh ${ORCHESTRATOR_ARGS[*]}"
          
          # æ£€æŸ¥ç¼–æ’å™¨æ˜¯å¦å¯ç”¨
          if [ -f "script/build-orchestrator.sh" ]; then
            # ä½¿ç”¨æ–°æ¶æ„
            if ./script/build-orchestrator.sh "${ORCHESTRATOR_ARGS[@]}"; then
              echo "config_generated=true" >> $GITHUB_OUTPUT
              echo "build_ready=true" >> $GITHUB_OUTPUT
              echo "âœ… æ„å»ºç¼–æ’æˆåŠŸ"
            else
              echo "âŒ æ„å»ºç¼–æ’å¤±è´¥ï¼Œå°è¯•å›é€€æ–¹æ¡ˆ"
              echo "config_generated=false" >> $GITHUB_OUTPUT
              echo "build_ready=false" >> $GITHUB_OUTPUT
            fi
          else
            # å›é€€åˆ°ä¼ ç»Ÿæ–¹å¼
            echo "ğŸ”„ ä½¿ç”¨ä¼ ç»Ÿæ„å»ºæ–¹å¼..."
            
            # ä¼ ç»Ÿæ–¹å¼ç”Ÿæˆé…ç½®
            if [ -f "script/generate-config.sh" ]; then
              chmod +x script/generate-config.sh
              
              TRADITIONAL_ARGS=("$DEVICE" "$PLUGINS")
              if [ "$AUTO_FIX" = "true" ]; then
                TRADITIONAL_ARGS+=("--auto-fix")
              fi
              
              if ./script/generate-config.sh "${TRADITIONAL_ARGS[@]}"; then
                echo "config_generated=true" >> $GITHUB_OUTPUT
                echo "build_ready=true" >> $GITHUB_OUTPUT
                echo "âœ… ä¼ ç»Ÿæ–¹å¼æ„å»ºå‡†å¤‡æˆåŠŸ"
              else
                echo "âŒ ä¼ ç»Ÿæ–¹å¼ä¹Ÿå¤±è´¥"
                echo "config_generated=false" >> $GITHUB_OUTPUT
                echo "build_ready=false" >> $GITHUB_OUTPUT
                exit 1
              fi
            else
              echo "âŒ æ— å¯ç”¨çš„æ„å»ºè„šæœ¬"
              exit 1
            fi
          fi
      
      - name: ğŸ“‹ éªŒè¯ç”Ÿæˆçš„é…ç½®
        run: |
          echo "ğŸ“‹ éªŒè¯ç”Ÿæˆçš„é…ç½®..."
          
          # æ£€æŸ¥å¿…éœ€æ–‡ä»¶
          REQUIRED_FILES=(".config" "feeds.conf.default")
          ALL_FILES_EXIST=true
          
          for file in "${REQUIRED_FILES[@]}"; do
            if [ -f "$file" ]; then
              SIZE=$(stat -c%s "$file")
              echo "âœ… $file å­˜åœ¨ ($SIZE å­—èŠ‚)"
            else
              echo "âŒ $file ä¸å­˜åœ¨"
              ALL_FILES_EXIST=false
            fi
          done
          
          if [ "$ALL_FILES_EXIST" = "true" ]; then
            echo "âœ… é…ç½®æ–‡ä»¶éªŒè¯é€šè¿‡"
            
            # æ˜¾ç¤ºé…ç½®æ‘˜è¦
            echo "ğŸ“„ .config æ–‡ä»¶å‰20è¡Œ:"
            head -20 .config || true
            echo "..."
            
            echo "ğŸ“„ feeds.conf.default å†…å®¹:"
            cat feeds.conf.default || true
          else
            echo "âŒ é…ç½®æ–‡ä»¶éªŒè¯å¤±è´¥"
            exit 1
          fi

          # å¤åˆ¶.configæ–‡ä»¶å¹¶ä¸”é‡å‘½åä¸ºconfig.default
          cp .config config.default
          echo "âœ… .config æ–‡ä»¶å·²å¤åˆ¶ä¸º config.default"
      
      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºé…ç½®
        uses: actions/upload-artifact@v4
        with:
          name: build-configs-${{ needs.config-analysis.outputs.build_id }}
          path: |
            config.default
            feeds.conf.default
            config/build.json
            logs/build-orchestrator.log
          retention-days: 7
          if-no-files-found: error

  # ä¸»è¦ç¼–è¯‘ä½œä¸š
  main-build:
    name: ğŸ”¨ ç¼–è¯‘å›ºä»¶ [${{ needs.config-analysis.outputs.source_branch }}][${{ needs.config-analysis.outputs.target_device }}]
    runs-on: ubuntu-24.04
    timeout-minutes: 360
    needs: [config-analysis, build-preparation]
    if: needs.build-preparation.outputs.build_ready == 'true'
    
    env:
      SOURCE_BRANCH: ${{ needs.config-analysis.outputs.source_branch }}
      TARGET_DEVICE: ${{ needs.config-analysis.outputs.target_device }}
      PLUGINS_LIST: ${{ needs.config-analysis.outputs.plugins_list }}
      BUILD_ID: ${{ needs.config-analysis.outputs.build_id }}
    
    steps:
      - name: ğŸš€ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
      
      - name: ğŸ’¾ ä¼˜åŒ–ç¼–è¯‘ç¯å¢ƒ
        run: |
          echo "ğŸ’¾ ä¼˜åŒ–ç¼–è¯‘ç¯å¢ƒ..."
          
          # æ˜¾ç¤ºç³»ç»Ÿä¿¡æ¯
          echo "ğŸ–¥ï¸ ç³»ç»Ÿèµ„æº:"
          echo "  CPU: $(nproc) æ ¸å¿ƒ"
          echo "  å†…å­˜: $(free -h | awk '/^Mem:/ {print $2}')"
          echo "  ç£ç›˜: $(df -h / | awk 'NR==2 {print $4}')"
          
          # æ¸…ç†ç©ºé—´
          sudo rm -rf /opt/ghc /usr/local/lib/android /usr/share/dotnet /etc/mysql /etc/php
          sudo apt-get clean
          
          # è®¾ç½®Gité…ç½®
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          echo "âœ… ç¯å¢ƒä¼˜åŒ–å®Œæˆ"
      
      - name: ğŸ“¥ ä¸‹è½½æ„å»ºé…ç½®
        uses: actions/download-artifact@v4
        with:
          name: build-configs-${{ env.BUILD_ID }}
          path: ./configs/
      
      - name: ğŸ”§ åº”ç”¨æ„å»ºé…ç½®
        run: |
          echo "ğŸ”§ åº”ç”¨æ„å»ºé…ç½®..."
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶
          if [ ! -f "configs/config.default" ]; then
            echo "âŒ æ„å»ºé…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
            ls -la configs/
            exit 1
          fi
          
          # åº”ç”¨é…ç½®
          cp configs/config.default ./.config
          cp configs/feeds.conf.default ./
          
          # è®¾ç½®æƒé™
          chmod 644 .config feeds.conf.default
          
          echo "âœ… æ„å»ºé…ç½®åº”ç”¨å®Œæˆ"
      
      - name: ğŸ“¦ ä¸‹è½½æºç 
        run: |
          echo "ğŸ“¦ ä¸‹è½½ OpenWrt æºç ..."
          
          case "${{ env.SOURCE_BRANCH }}" in
            "lede-master")
              git clone --depth 1 https://github.com/coolsnowwolf/lede.git openwrt
              ;;
            "openwrt-main")
              git clone --depth 1 https://github.com/openwrt/openwrt.git openwrt
              ;;
            "immortalwrt-master")
              git clone --depth 1 https://github.com/immortalwrt/immortalwrt.git openwrt
              ;;
            "Lienol-master")
              git clone --depth 1 https://github.com/Lienol/openwrt.git openwrt
              ;;
            *)
              echo "âŒ ä¸æ”¯æŒçš„æºç åˆ†æ”¯: ${{ env.SOURCE_BRANCH }}"
              exit 1
              ;;
          esac
          
          cd openwrt
          echo "âœ… æºç ä¸‹è½½å®Œæˆ"
          echo "ğŸ“Š æºç ä¿¡æ¯:"
          echo "  åˆ†æ”¯: $(git branch --show-current)"
          echo "  æäº¤: $(git rev-parse --short HEAD)"
          echo "  å¤§å°: $(du -sh . | cut -f1)"
      
      - name: ğŸ”„ æ›´æ–°å’Œå®‰è£… Feeds
        run: |
          cd openwrt
          
          echo "ğŸ”„ å¤åˆ¶ feeds é…ç½®..."
          cp ../feeds.conf.default ./

          echo "ğŸ”„ å¤åˆ¶ config é…ç½®..."
          cp ../.config ./

          echo "ğŸ“‹ å½“å‰feedsé…ç½®:"
          cat feeds.conf.default

          echo "ğŸ“‹ ç¼–è¯‘é…ç½®é¢„è§ˆ:"
          head -30 openwrt/.config
          
          echo "ğŸ”„ æ›´æ–° feeds..."
          ./scripts/feeds update -a
          
          echo "ğŸ“¦ å®‰è£… feeds..."
          ./scripts/feeds install -a
          
          echo "âœ… Feeds æ›´æ–°å®Œæˆ"

      - name: ğŸ”§ ç¬¬ä¸€é˜¶æ®µè‡ªå®šä¹‰è„šæœ¬
        run: |
          echo "ğŸ”§ æ‰§è¡Œç¬¬ä¸€é˜¶æ®µè‡ªå®šä¹‰è„šæœ¬..."
          cd openwrt
          
          # æ ¹æ®æºç åˆ†æ”¯æ‰§è¡Œç›¸åº”çš„è‡ªå®šä¹‰æ“ä½œ
          case "${{ needs.prepare.outputs.source_branch }}" in
            "openwrt-main")
              echo "ğŸ”§ OpenWrtå®˜æ–¹æºç è‡ªå®šä¹‰é…ç½®..."
              # åˆ é™¤å¯èƒ½å†²çªçš„åŒ…
              rm -rf package/utils/{ucode,fbtest} || true
              ;;
            "lede-master")
              echo "ğŸ”§ Lean's LEDEæºç è‡ªå®šä¹‰é…ç½®..."
              # åˆ é™¤å¯èƒ½å†²çªçš„åŒ…
              rm -rf package/lean/{samba4,luci-app-samba4,luci-app-ttyd} || true
              ;;
            "immortalwrt-master")
              echo "ğŸ”§ ImmortalWrtæºç è‡ªå®šä¹‰é…ç½®..."
              # åˆ é™¤å¯èƒ½å†²çªçš„åŒ…
              rm -rf package/emortal/{autosamba,ipv6-helper} || true
              ;;
            "Lienol-master")
              echo "ğŸ”§ Lienolæºç è‡ªå®šä¹‰é…ç½®..."
              # æ·»åŠ ç‰¹å®šé…ç½®
              ;;
          esac
          
          echo "âœ… ç¬¬ä¸€é˜¶æ®µè‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå®Œæˆ"

      - name: ğŸ”§ ç¬¬äºŒé˜¶æ®µè‡ªå®šä¹‰è„šæœ¬
        run: |
          echo "ğŸ”§ æ‰§è¡Œç¬¬äºŒé˜¶æ®µè‡ªå®šä¹‰è„šæœ¬..."
          cd openwrt
          
          # ä¿®æ”¹é»˜è®¤IPåœ°å€ï¼ˆæ ¹æ®è®¾å¤‡ç±»å‹å¯èƒ½éœ€è¦ä¸åŒé…ç½®ï¼‰
          case "${{ needs.prepare.outputs.target_device }}" in
            "x86_64")
              echo "ğŸ”§ é…ç½®X86è®¾å¤‡é»˜è®¤å‚æ•°..."
              sed -i 's/192.168.1.1/192.168.50.1/g' package/base-files/files/bin/config_generate || true
              ;;
            *)
              echo "ğŸ”§ é…ç½®è·¯ç”±å™¨è®¾å¤‡é»˜è®¤å‚æ•°..."
              # ä¿æŒé»˜è®¤IP 192.168.1.1 å¯¹äºè·¯ç”±å™¨è®¾å¤‡é€šå¸¸æ›´åˆé€‚
              ;;
          esac
          
          # ä¿®æ”¹é»˜è®¤ä¸»æœºå
          sed -i "s/OpenWrt/${{ needs.prepare.outputs.device_name }}/g" package/base-files/files/bin/config_generate || true
          
          # ä¿®æ”¹æ—¶åŒº
          sed -i "s/'UTC'/'CST-8'/g" package/base-files/files/bin/config_generate || true
          
          echo "âœ… ç¬¬äºŒé˜¶æ®µè‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå®Œæˆ"
  
      - name: ğŸ“‹ ç”Ÿæˆé…ç½®
        run: |
          cd openwrt
          echo "ğŸ“‹ ç”Ÿæˆæœ€ç»ˆé…ç½®..."
          make defconfig
          
          echo "ğŸ“‹ é…ç½®å·®å¼‚å¯¹æ¯”:"
          ./scripts/diffconfig.sh || true

      - name: ğŸ“¥ ä¸‹è½½ä¾èµ–åŒ…
        run: |
          cd openwrt
          echo "ğŸ“¥ ä¸‹è½½ç¼–è¯‘ä¾èµ–åŒ…..."
          make download -j8
          
          # æ£€æŸ¥ä¸‹è½½ç»“æœ
          find dl -size -1024c -exec ls -l {} \; || true
  
      
      - name: ğŸ”¨ ç¼–è¯‘å›ºä»¶
        run: |
          cd openwrt
          
          echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘å›ºä»¶..."
          echo "â° å¼€å§‹æ—¶é—´: $(date)"
          
          # æ ¹æ®è®¾å¤‡ç±»å‹è°ƒæ•´ç¼–è¯‘å‚æ•°
          case "${{ env.TARGET_DEVICE }}" in
            "x86_64")
              MAKE_JOBS=$(nproc)
              ;;
            "rpi_4b"|"nanopi_r2s")
              MAKE_JOBS=$(($(nproc) * 3 / 4))  # ARMè®¾å¤‡ä½¿ç”¨75%çš„æ ¸å¿ƒ
              ;;
            *)
              MAKE_JOBS=$(($(nproc) / 2))      # ä½é…è®¾å¤‡ä½¿ç”¨50%çš„æ ¸å¿ƒ
              ;;
          esac
          
          echo "ğŸ”§ ä½¿ç”¨ $MAKE_JOBS ä¸ªå¹¶å‘ä»»åŠ¡"
          
          # æ‰§è¡Œç¼–è¯‘
          make -j$MAKE_JOBS V=s
          
          echo "âœ… å›ºä»¶ç¼–è¯‘å®Œæˆ"
          echo "â° ç»“æŸæ—¶é—´: $(date)"
      
      - name: ğŸ“Š æ£€æŸ¥ç¼–è¯‘ç»“æœ
        run: |
          cd openwrt
          
          echo "ğŸ“Š æ£€æŸ¥ç¼–è¯‘ç»“æœ..."
          
          # æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶
          FIRMWARE_PATH="bin/targets/*/*"
          if ls $FIRMWARE_PATH/*.img.gz 2>/dev/null || ls $FIRMWARE_PATH/*.bin 2>/dev/null; then
            echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸ"
            
            echo "ğŸ“¦ å›ºä»¶æ–‡ä»¶:"
            ls -lah $FIRMWARE_PATH/ | grep -E '\.(img\.gz|bin|vmdk|vdi)$' || true
            
            # è®¡ç®—æ–‡ä»¶å¤§å°
            TOTAL_SIZE=$(du -sh bin/targets/ | cut -f1)
            echo "ğŸ“ æ€»å¤§å°: $TOTAL_SIZE"
          else
            echo "âŒ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶"
            echo "ğŸ“‹ bin/targets ç›®å½•å†…å®¹:"
            ls -la bin/targets/*/ || true
            exit 1
          fi
      
      - name: ğŸ“¤ ä¸Šä¼ å›ºä»¶
        uses: actions/upload-artifact@v4
        with:
          name: OpenWrt-${{ env.TARGET_DEVICE }}-${{ env.BUILD_ID }}
          path: |
            openwrt/bin/targets/*/*
            !openwrt/bin/targets/*/*/packages
          retention-days: 7
          if-no-files-found: error
      
      - name: ğŸ“‹ ç”Ÿæˆç¼–è¯‘æŠ¥å‘Š
        if: always()
        run: |
          echo "ğŸ“‹ ç”Ÿæˆç¼–è¯‘æŠ¥å‘Š..."
          
          # åˆ›å»ºæŠ¥å‘Šæ–‡ä»¶
          cat > build-report.md << EOF
          # ğŸ”¨ OpenWrt ç¼–è¯‘æŠ¥å‘Š
          
          ## ğŸ“Š åŸºæœ¬ä¿¡æ¯
          - **æ„å»ºID**: ${{ env.BUILD_ID }}
          - **ç›®æ ‡è®¾å¤‡**: ${{ env.TARGET_DEVICE }}
          - **æºç åˆ†æ”¯**: ${{ env.SOURCE_BRANCH }}
          - **æ’ä»¶åˆ—è¡¨**: ${{ env.PLUGINS_LIST || 'æ— ' }}
          - **ç¼–è¯‘æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
          - **ç¼–è¯‘çŠ¶æ€**: ${{ job.status }}
          
          ## ğŸ¯ ç¼–è¯‘ç»“æœ
          EOF
          
          cd openwrt 2>/dev/null || true
          
          if [ -d "bin/targets" ]; then
            echo "### âœ… ç¼–è¯‘æˆåŠŸ" >> ../build-report.md
            echo "**å›ºä»¶æ–‡ä»¶:**" >> ../build-report.md
            ls bin/targets/*/*/*.{img.gz,bin,vmdk,vdi} 2>/dev/null | while read file; do
              size=$(stat -c%s "$file" 2>/dev/null | numfmt --to=iec || echo "æœªçŸ¥")
              echo "- $(basename "$file") ($size)" >> ../build-report.md
            done
          else
            echo "### âŒ ç¼–è¯‘å¤±è´¥" >> ../build-report.md
          fi
          
          echo "âœ… ç¼–è¯‘æŠ¥å‘Šå·²ç”Ÿæˆ"
      
      - name: ğŸ“¤ ä¸Šä¼ ç¼–è¯‘æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-report-${{ env.BUILD_ID }}
          path: build-report.md
          retention-days: 30
          if-no-files-found: warn

  # æ¸…ç†å’Œé€šçŸ¥ä½œä¸š
  cleanup-and-notify:
    name: ğŸ§¹ æ¸…ç†ä¸é€šçŸ¥
    runs-on: ubuntu-24.04
    needs: [config-analysis, build-preparation, main-build]
    if: always()
    
    steps:
      - name: ğŸ“Š åˆ†ææ„å»ºç»“æœ
        run: |
          echo "ğŸ“Š åˆ†ææ„å»ºç»“æœ..."
          
          CONFIG_RESULT="${{ needs.config-analysis.result }}"
          PREP_RESULT="${{ needs.build-preparation.result }}"
          BUILD_RESULT="${{ needs.main-build.result }}"
          
          echo "ğŸ” å„é˜¶æ®µç»“æœ:"
          echo "  é…ç½®åˆ†æ: $CONFIG_RESULT"
          echo "  æ„å»ºå‡†å¤‡: $PREP_RESULT"
          echo "  ä¸»è¦ç¼–è¯‘: $BUILD_RESULT"
          
          # è®¾ç½®æ€»ä½“çŠ¶æ€
          if [ "$BUILD_RESULT" = "success" ]; then
            echo "OVERALL_STATUS=success" >> $GITHUB_ENV
            echo "âœ… æ•´ä½“ç¼–è¯‘æˆåŠŸ"
          elif [ "$CONFIG_RESULT" = "failure" ]; then
            echo "OVERALL_STATUS=config_failed" >> $GITHUB_ENV
            echo "âŒ é…ç½®é˜¶æ®µå¤±è´¥"
          elif [ "$PREP_RESULT" = "failure" ]; then
            echo "OVERALL_STATUS=preparation_failed" >> $GITHUB_ENV
            echo "âŒ å‡†å¤‡é˜¶æ®µå¤±è´¥"
          else
            echo "OVERALL_STATUS=build_failed" >> $GITHUB_ENV
            echo "âŒ ç¼–è¯‘é˜¶æ®µå¤±è´¥"
          fi
      
      - name: ğŸ§¹ æ¸…ç†å·¥ä½œç©ºé—´
        run: |
          echo "ğŸ§¹ æ¸…ç†å·¥ä½œç©ºé—´..."
          
          # æ¸…ç†å¤§æ–‡ä»¶
          sudo rm -rf openwrt/build_dir openwrt/tmp 2>/dev/null || true
          
          # æ˜¾ç¤ºå‰©ä½™ç©ºé—´
          echo "ğŸ’¾ å‰©ä½™ç£ç›˜ç©ºé—´:"
          df -h /
          
          echo "âœ… æ¸…ç†å®Œæˆ"
      
      - name: ğŸ“¢ æ„å»ºçŠ¶æ€é€šçŸ¥
        if: env.OVERALL_STATUS == 'success'
        run: |
          echo "ğŸ“¢ æ„å»ºæˆåŠŸé€šçŸ¥"
          echo "ğŸ‰ OpenWrt å›ºä»¶ç¼–è¯‘æˆåŠŸï¼"
          echo "ğŸ“¦ è®¾å¤‡: ${{ needs.config-analysis.outputs.target_device }}"
          echo "ğŸŒ¿ åˆ†æ”¯: ${{ needs.config-analysis.outputs.source_branch }}"
          echo "ğŸ”— ä¸‹è½½é“¾æ¥: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
      
      - name: ğŸ“¢ æ„å»ºå¤±è´¥é€šçŸ¥
        if: env.OVERALL_STATUS != 'success'
        run: |
          echo "ğŸ“¢ æ„å»ºå¤±è´¥é€šçŸ¥"
          echo "âŒ OpenWrt å›ºä»¶ç¼–è¯‘å¤±è´¥"
          echo "ğŸ“¦ è®¾å¤‡: ${{ needs.config-analysis.outputs.target_device }}"
          echo "ğŸŒ¿ åˆ†æ”¯: ${{ needs.config-analysis.outputs.source_branch }}"
          echo "ğŸ”— æ—¥å¿—é“¾æ¥: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "ğŸ“‹ å¤±è´¥é˜¶æ®µ: ${{ env.OVERALL_STATUS }}"